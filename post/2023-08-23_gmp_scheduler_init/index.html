<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    

    <title>深入理解Go调度器：调度器的初始化（五） | 凯文的个人博客</title>
    <meta property="og:title" content="深入理解Go调度器：调度器的初始化（五） - 凯文的个人博客">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2023-08-23T00:00:00&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2023-08-28T20:09:33&#43;08:00'>
        
    <meta name="Keywords" content="golang,博客">
    <meta name="description" content="深入理解Go调度器：调度器的初始化（五）">
        
    <meta name="author" content="Kevin">
    <meta property="og:url" content="http://www.subond.com/post/2023-08-23_gmp_scheduler_init/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
    
    
    
</head>

<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="http://www.subond.com/">
                        凯文的个人博客
                    </a>
                
                <p class="description">专注于云计算网络，个人成长</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="http://www.subond.com/">首页</a>
                    
                    <a  href="http://www.subond.com/archives/" title="归档">归档</a>
                    
                    <a  href="http://www.subond.com/reading/" title="阅读">阅读</a>
                    
                    <a  href="http://www.subond.com/about/" title="关于我">关于我</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">深入理解Go调度器：调度器的初始化（五）</h1>
        </header>
        <date class="post-meta meta-date">
            2023年8月23日
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category">
                <a href='/categories/go%E7%AC%94%E8%AE%B0' target="_blank">Go笔记</a>
            </span>
            
            <span class="meta-category">
                <a href='/categories/%E6%8A%80%E6%9C%AF' target="_blank">技术</a>
            </span>
            
        </div>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span>
                    阅读</span></span>
        </div>
        
        
        <div class="post-content">
            <p>[toc]</p>
<h2 id="调度器的初始化">调度器的初始化</h2>
<p>这篇文章，主要引自阿波张公众号「源码游记」的<a href="https://mp.weixin.qq.com/s/W9D4Sl-6jYfcpczzdPfByQ">Go语言goroutine调度器初始化</a>，并对照 go 1.20.3 版本的源码进行分析学习，主要包含以下内容：</p>
<ul>
<li>程序如何被系统加载</li>
<li>从汇编语言看 go 程序的加载过程</li>
<li>go 调度器的初始化</li>
</ul>
<blockquote>
<p>任何一个由编译型语言（不管是C，C++，go还是汇编语言）所编写的程序在被操作系统加载起来运行时都会顺序经过如下几个阶段：</p>
<ol>
<li>从磁盘上把可执行程序读入内存；</li>
<li>创建进程和主线程；</li>
<li>为主线程分配栈空间；</li>
<li>把由用户在命令行输入的参数拷贝到主线程的栈；</li>
<li>把主线程放入操作系统的运行队列等待被调度执起来运行。</li>
</ol>
</blockquote>
<p>以上引用自阿波张公众号「源码游记」<a href="https://mp.weixin.qq.com/s/W9D4Sl-6jYfcpczzdPfByQ">调度器初始化篇</a>，</p>
<p>我们找到<code>rt0_linux_amd64.s</code>文件，这个文件是 go 汇编语言编写的源代码文件。其第 8 行的内容是：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// src/runtime/rt0_linux_amd64.s
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>TEXT <span style="color:#900;font-weight:bold">_rt0_amd64_linux</span>(SB),NOSPLIT,<span style="color:#a61717;background-color:#e3d2d2">$</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">8</span>
</span></span><span style="display:flex;"><span>     JMP <span style="color:#900;font-weight:bold">_rt0_amd64</span>(SB)
</span></span></code></pre></td></tr></table>
</div>
</div><p>第一行<code>TEXT</code>定义了 <code>_rt0_amd64_linux</code> 这个符号，第二行 <code>JMP</code> 才是真正的指令，也就是主线程的第一条指令。</p>
<p>该指令的意思是跳转到 <code>_rt0_amd64</code> 符号处继续执行，这个符号的定义在<code>src/runtime/asm_amd64.s</code>文件中。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// src/runtime/asm_amd64.s#L11
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// _rt0_amd64 is common startup code for most amd64 systems when using
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// internal linking. This is the entry point for the program from the
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// kernel for an ordinary -buildmode=exe program. The stack holds the
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// number of arguments and the C-style argv.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>TEXT <span style="color:#900;font-weight:bold">_rt0_amd64</span>(SB),NOSPLIT,<span style="color:#a61717;background-color:#e3d2d2">$</span><span style="color:#000;font-weight:bold">-</span><span style="color:#099">8</span>
</span></span><span style="display:flex;"><span>	MOVQ	<span style="color:#099">0</span>(SP), DI	<span style="color:#998;font-style:italic">// argc,用的 MOVQ,即将argc值加载到 DI 上
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	LEAQ	<span style="color:#099">8</span>(SP), SI	<span style="color:#998;font-style:italic">// argv,注意用的 LEAQ,即将argv的地址加载到 SI 上
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	JMP	runtime<span style="color:#a61717;background-color:#e3d2d2">·</span><span style="color:#900;font-weight:bold">rt0_go</span>(SB)
</span></span></code></pre></td></tr></table>
</div>
</div><p>这是整个程序的启动入口，前两行命令分别是将操作系统传递过来的参数<code>argc</code>和<code>argv</code>数组的地址分别放在 DI 和 SI 寄存器中。</p>
<p>第三行，跳转到<code>runtime.rt0_go</code> 继续执行。</p>
<p>我们继续看<code>runtime.rt0_go</code>的内容：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>TEXT runtime<span style="color:#a61717;background-color:#e3d2d2">·</span><span style="color:#900;font-weight:bold">rt0_go</span>(SB),NOSPLIT|TOPFRAME,<span style="color:#a61717;background-color:#e3d2d2">$</span><span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// copy arguments forward on an even stack
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	MOVQ	DI, AX		<span style="color:#998;font-style:italic">// argc, AX = argc
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	MOVQ	SI, BX		<span style="color:#998;font-style:italic">// argv, BX = &amp;argv
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	SUBQ	<span style="color:#a61717;background-color:#e3d2d2">$</span>(<span style="color:#099">5</span><span style="color:#000;font-weight:bold">*</span><span style="color:#099">8</span>), SP		<span style="color:#998;font-style:italic">// 3args 2auto 预留 40个字节
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	ANDQ	<span style="color:#a61717;background-color:#e3d2d2">$~</span><span style="color:#099">15</span>, SP    <span style="color:#998;font-style:italic">// 调整栈顶寄存器，使其按 16 字节对齐
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	MOVQ	AX, <span style="color:#099">24</span>(SP)  <span style="color:#998;font-style:italic">// argc 放到 SP + 24 字节处
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	MOVQ	BX, <span style="color:#099">32</span>(SP)  <span style="color:#998;font-style:italic">// &amp;argv 放到 SP + 32 字节处
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>先看这条命令<code>SUBQ $(5*8) SP</code>，即 <code>SP = SP - 40</code>，将 SP 指针向下移动 40个字节。</p>
<p>指令<code>AND $~15 SP</code>，即将 15 取反，并于 SP 进行 <code>&amp;</code> 运算。15 的二进制是<code>1111</code>，取反后，变成<code>0000</code>，再跟 SP 相与，相当于把 SP 又变小了，向下移动了 8 个字节。</p>
<p>这样说可能比较难理解，我们画张图就清楚了。</p>
<p>
        <img class="mx-auto" alt="go_scheduler-sched_stack" src="https://wechat-1315555539.cos.ap-nanjing.myqcloud.com/uPic/go_scheduler-sched_stack.png" />   
    </p>
<p>简单总结一下，这几行代码的工作就是在栈顶寄存器上预留一定的空间，并使其按 16 字节对齐，将参数 <code>argv</code> 和 <code>argv</code>搬到新的位置。</p>
<p>至于为什么按 16 字节对齐，是因为 CPU 有一组 SSE 指令，这些指令中出现的内存地址必须是 16 的整数倍。</p>
<h3 id="初始化g0栈空间">初始化g0栈空间</h3>
<p>好啦，我们接着看后面的代码。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// create istack out of the given (operating system) stack.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// _cgo_init may update stackguard.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	MOVQ	<span style="color:#a61717;background-color:#e3d2d2">$</span>runtime<span style="color:#a61717;background-color:#e3d2d2">·</span><span style="color:#900;font-weight:bold">g0</span>(SB), DI   <span style="color:#998;font-style:italic">// 将g0的地址放入 DI 寄存器
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#900;font-weight:bold">LEAQ</span>	(<span style="color:#000;font-weight:bold">-</span><span style="color:#099">64</span><span style="color:#000;font-weight:bold">*</span><span style="color:#099">1024</span><span style="color:#000;font-weight:bold">+</span><span style="color:#099">104</span>)(SP), BX  <span style="color:#998;font-style:italic">// BX = SP - 64K + 104
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	MOVQ	BX, <span style="color:#900;font-weight:bold">g_stackguard0</span>(DI)   <span style="color:#998;font-style:italic">// g_stackguard0 = SP - 64K + 104
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	MOVQ	BX, <span style="color:#900;font-weight:bold">g_stackguard1</span>(DI)   <span style="color:#998;font-style:italic">// g_stackguard0 = SP - 64K + 104
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	MOVQ	BX, (g_stack<span style="color:#000;font-weight:bold">+</span>stack_lo)(DI)  <span style="color:#998;font-style:italic">// g0.stack.lo = SP - 64K + 104
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	MOVQ	SP, (g_stack<span style="color:#000;font-weight:bold">+</span>stack_hi)(DI)  <span style="color:#998;font-style:italic">// g0.stack.hi = SP
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这几行代码就是将 g0 的内存栈进行设定，而且可以看到 g0的内存栈总共大约 64K 字节，地址范围是<code>[SP - 64K + 104, SP]</code>。</p>
<p>执行到这，g0 的栈空间如下：</p>
<p>
        <img class="mx-auto" alt="go_scheduler-sched_g0" src="https://wechat-1315555539.cos.ap-nanjing.myqcloud.com/uPic/go_scheduler-sched_g0.png" />   
    </p>
<h3 id="主线程绑定m0">主线程绑定m0</h3>
<p>中间是一些跟 CPU 相关的代码，我们暂时先跳过，直接来到跟 m0 相关的部分：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>LEAQ	runtime<span style="color:#a61717;background-color:#e3d2d2">·</span>m0<span style="color:#000;font-weight:bold">+</span><span style="color:#900;font-weight:bold">m_tls</span>(SB), DI  <span style="color:#998;font-style:italic">// DI = &amp;m0.tls, 即将 m0 tls 成员地址放入 DI 寄存器
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>CALL	runtime<span style="color:#a61717;background-color:#e3d2d2">·</span><span style="color:#900;font-weight:bold">settls</span>(SB)        <span style="color:#998;font-style:italic">// 调用 settls 设置工作线程 m 的本地存储
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// store through it, to make sure it works
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 验证是否可以工作，如果有问题则 abrot 退出程序
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#900;font-weight:bold">get_tls</span>(BX)  <span style="color:#998;font-style:italic">// 获取 fs 段基地址并放入 BX 寄存器，也就是m0.tls[1]的地址，get_tls 的代码由编译器生成
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>MOVQ	<span style="color:#a61717;background-color:#e3d2d2">$</span><span style="color:#099">0x123</span>, <span style="color:#900;font-weight:bold">g</span>(BX)  <span style="color:#998;font-style:italic">// 
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>MOVQ	runtime<span style="color:#a61717;background-color:#e3d2d2">·</span>m0<span style="color:#000;font-weight:bold">+</span><span style="color:#900;font-weight:bold">m_tls</span>(SB), AX <span style="color:#998;font-style:italic">// AX = m0.tls[0]
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>CMPQ	AX, <span style="color:#a61717;background-color:#e3d2d2">$</span><span style="color:#099">0x123</span>    
</span></span><span style="display:flex;"><span>JEQ <span style="color:#099">2</span>(PC)
</span></span><span style="display:flex;"><span>CALL	runtime<span style="color:#a61717;background-color:#e3d2d2">·</span><span style="color:#900;font-weight:bold">abort</span>(SB)
</span></span></code></pre></td></tr></table>
</div>
</div><p>这段代码先是调用<code>settls</code>函数初始化主线程的线程本地存储（TLS），<strong>目的是把m0和主线程关联在一起</strong>。</p>
<blockquote>
<p>【因为 m0 是全局变量，而且 m0 要绑定到工作线程才能执行。】</p>
<p>我们知道，runtime 会启动多个工作线程，每个线程都绑定一个m0。而且，代码还得保持一致，都是用 m0 表示。</p>
<p>这就要用到线程本地存储的知识了，即 TLS （Thread Local Storage），简单来说，TLS 就是线程本地的私有的全局变量。</p>
<p>一般而言，全局变量对进程中多个线程同时可见。</p>
<p>进程中的全局变量与函数内定义的静态变量，是各个线程都可以访问的共享变量。（静态变量放在堆上）</p>
<p>一个线程修改了，其他线程就会“看见“。</p>
<p>要想搞出一个线程私有的变量，就得用到 TLS 技术。</p>
</blockquote>
<p>接下来的几行代码是为了验证 TLS 功能是否正常，如果不正常，直接 abort 退出程序。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#900;font-weight:bold">get_tls</span>(BX)  <span style="color:#998;font-style:italic">// 获取 fs 段基地址并放入 BX 寄存器，也就是m0.tls[0]的地址，get_tls 的代码由编译器生成
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>MOVQ	<span style="color:#a61717;background-color:#e3d2d2">$</span><span style="color:#099">0x123</span>, <span style="color:#900;font-weight:bold">g</span>(BX)  <span style="color:#998;font-style:italic">// 将常量 0x123 放入 BX 中
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>MOVQ	runtime<span style="color:#a61717;background-color:#e3d2d2">·</span>m0<span style="color:#000;font-weight:bold">+</span><span style="color:#900;font-weight:bold">m_tls</span>(SB), AX <span style="color:#998;font-style:italic">// AX = m0.tls[0]
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>CMPQ	AX, <span style="color:#a61717;background-color:#e3d2d2">$</span><span style="color:#099">0x123</span>    <span style="color:#998;font-style:italic">// 比较 AX 的值是否与 0x123 相等
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>JEQ <span style="color:#099">2</span>(PC)           <span style="color:#998;font-style:italic">// 相等则跳过第 6 行代码
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>CALL	runtime<span style="color:#a61717;background-color:#e3d2d2">·</span><span style="color:#900;font-weight:bold">abort</span>(SB) <span style="color:#998;font-style:italic">// 不想当，直接 abort
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>继续往下看。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// set the per-goroutine and per-mach &#34;registers&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#900;font-weight:bold">get_tls</span>(BX)
</span></span><span style="display:flex;"><span>LEAQ	runtime<span style="color:#a61717;background-color:#e3d2d2">·</span><span style="color:#900;font-weight:bold">g0</span>(SB), CX  <span style="color:#998;font-style:italic">// 将 g0 的地址放入 CX, 即CX = &amp;g0
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>MOVQ	CX, <span style="color:#900;font-weight:bold">g</span>(BX)           <span style="color:#998;font-style:italic">// 将 g0 的地址放入线程的本地存储，即 m0.tls[0] = &amp;g0
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>LEAQ	runtime<span style="color:#a61717;background-color:#e3d2d2">·</span><span style="color:#900;font-weight:bold">m0</span>(SB), AX  <span style="color:#998;font-style:italic">// 将 m0 的地址放入 AX
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// save m-&gt;g0 = g0
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>MOVQ	CX, <span style="color:#900;font-weight:bold">m_g0</span>(AX)   <span style="color:#998;font-style:italic">// m0.g0 = &amp;g0
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// save m0 to g0-&gt;m
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>MOVQ	AX, <span style="color:#900;font-weight:bold">g_m</span>(CX)    <span style="color:#998;font-style:italic">// g0.m = &amp;m0
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>通过这几行代码将 m0 和 g0 进行关联，这个时候，我们可以得到：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>m0.tls[<span style="color:#099">0</span>] = <span style="color:#000;font-weight:bold">&amp;</span>g0
</span></span><span style="display:flex;"><span>m0.g0 = <span style="color:#000;font-weight:bold">&amp;</span>g0
</span></span><span style="display:flex;"><span>g0.m = <span style="color:#000;font-weight:bold">&amp;</span>m0
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>从这里可以看到，保存在主线程本地存储中的值是 g0 的地址，也就是说工作线程的私有全局变量其实是一个指向 g0 的指针，而不是指向 m 的指针。</p>
<p>当前这个指针指向 g0，表示代码正运行在 g0 栈。</p>
</blockquote>
<p>还有一点就是，<strong>程序的运行其实就是栈空间内容的执行和切换，所以 tls 的值是 g0 的地址，而不是 m 的</strong>。</p>
<p>这时候，我们的图就更新成这个样子：</p>
<p>
        <img class="mx-auto" alt="go_scheduler-sched_g0m0" src="https://wechat-1315555539.cos.ap-nanjing.myqcloud.com/uPic/go_scheduler-sched_g0m0.png" />   
    </p>
<h2 id="初始化m0">初始化m0</h2>
<p>下面就开始初始化 m0了。我们继续看代码：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	MOVL	<span style="color:#099">24</span>(SP), AX		<span style="color:#998;font-style:italic">// copy argc
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	MOVL	AX, <span style="color:#099">0</span>(SP)
</span></span><span style="display:flex;"><span>	MOVQ	<span style="color:#099">32</span>(SP), AX		<span style="color:#998;font-style:italic">// copy argv
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	MOVQ	AX, <span style="color:#099">8</span>(SP)
</span></span><span style="display:flex;"><span>	CALL	runtime<span style="color:#a61717;background-color:#e3d2d2">·</span><span style="color:#900;font-weight:bold">args</span>(SB)
</span></span><span style="display:flex;"><span>	CALL	runtime<span style="color:#a61717;background-color:#e3d2d2">·</span><span style="color:#900;font-weight:bold">osinit</span>(SB)
</span></span><span style="display:flex;"><span>	CALL	runtime<span style="color:#a61717;background-color:#e3d2d2">·</span><span style="color:#900;font-weight:bold">schedinit</span>(SB)
</span></span></code></pre></td></tr></table>
</div>
</div><p>前 4 行通过 MOV 操作将命令行参数放到 SP 的栈顶，紧接着调用<code>runtime.args</code>函数，处理命令行参数。</p>
<p>后面 2 行，连续调用两个 runtime 函数，分别是系统初始化<code>osinit</code> 和 调度器<code>schedint</code>初始化。本文主要关注调度器的初始化，我们重点看<code>schedinit</code>函数。</p>
<p>终于来到了 go 函数，看着顺眼多了。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// src/runtime/proc.go#L677
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// The bootstrap sequence is:
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//	call osinit
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//	call schedinit
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//	make &amp; queue new G
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//	call runtime·mstart
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// The new G calls runtime·main.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">schedinit</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 前面是一些锁的初始化，可以忽略
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">......</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 上来先做竞态检查，跟调度器初始化无关，可跳过
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	gp <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">getg</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> raceenabled {
</span></span><span style="display:flex;"><span>		gp.racectx, raceprocctx0 = <span style="color:#900;font-weight:bold">raceinit</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 设置最多启动 10000 个操作系统线程，即 10000 个 M
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	sched.maxmcount = <span style="color:#099">10000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// The world starts stopped.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#900;font-weight:bold">worldStopped</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#900;font-weight:bold">moduledataverify</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#900;font-weight:bold">stackinit</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#900;font-weight:bold">mallocinit</span>()
</span></span><span style="display:flex;"><span>	godebug <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">getGodebugEarly</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#900;font-weight:bold">initPageTrace</span>(godebug) <span style="color:#998;font-style:italic">// must run after mallocinit but before anything allocates
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#900;font-weight:bold">cpuinit</span>(godebug)       <span style="color:#998;font-style:italic">// must run before alginit
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#900;font-weight:bold">alginit</span>()              <span style="color:#998;font-style:italic">// maps, hash, fastrand must not be used before this call
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#900;font-weight:bold">fastrandinit</span>()         <span style="color:#998;font-style:italic">// must run before mcommoninit
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#900;font-weight:bold">mcommoninit</span>(gp.m, <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#900;font-weight:bold">modulesinit</span>()   <span style="color:#998;font-style:italic">// provides activeModules
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#900;font-weight:bold">typelinksinit</span>() <span style="color:#998;font-style:italic">// uses maps, activeModules
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#900;font-weight:bold">itabsinit</span>()     <span style="color:#998;font-style:italic">// uses activeModules
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#900;font-weight:bold">stkobjinit</span>()    <span style="color:#998;font-style:italic">// must run before GC starts
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#900;font-weight:bold">sigsave</span>(<span style="color:#000;font-weight:bold">&amp;</span>gp.m.sigmask)
</span></span><span style="display:flex;"><span>	initSigmask = gp.m.sigmask
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#900;font-weight:bold">goargs</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#900;font-weight:bold">goenvs</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#900;font-weight:bold">parsedebugvars</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#900;font-weight:bold">gcinit</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// if disableMemoryProfiling is set, update MemProfileRate to 0 to turn off memprofile.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// Note: parsedebugvars may update MemProfileRate, but when disableMemoryProfiling is
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// set to true by the linker, it means that nothing is consuming the profile, it is
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// safe to set MemProfileRate to 0.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> disableMemoryProfiling {
</span></span><span style="display:flex;"><span>		MemProfileRate = <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#900;font-weight:bold">lock</span>(<span style="color:#000;font-weight:bold">&amp;</span>sched.lock)
</span></span><span style="display:flex;"><span>	sched.lastpoll.<span style="color:#900;font-weight:bold">Store</span>(<span style="color:#900;font-weight:bold">nanotime</span>())
</span></span><span style="display:flex;"><span>	procs <span style="color:#000;font-weight:bold">:=</span> ncpu   <span style="color:#998;font-style:italic">// 系统有多少核，就创建多少个P
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 如果存在环境变量GOMAXPROCS，取环境变量的值，创建指定个数的 P
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> n, ok <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">atoi32</span>(<span style="color:#900;font-weight:bold">gogetenv</span>(<span style="color:#d14">&#34;GOMAXPROCS&#34;</span>)); ok <span style="color:#000;font-weight:bold">&amp;&amp;</span> n &gt; <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>		procs = n
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// procresize 函数具体创建 P
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> <span style="color:#900;font-weight:bold">procresize</span>(procs) <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">throw</span>(<span style="color:#d14">&#34;unknown runnable goroutine during bootstrap&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#900;font-weight:bold">unlock</span>(<span style="color:#000;font-weight:bold">&amp;</span>sched.lock)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// World is effectively started now, as P&#39;s can run.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#900;font-weight:bold">worldStarted</span>()
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">......</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意，这段代码有个特殊的函数<code>getg</code>，该函数是由编译器实现的，我们在源码中找不到其定义。这个函数的作用是从线程本地存储中获取当前正在运行的 g。从这里的代码可以看出，当前取出来的是 g0。</p>
<p>除去一些必要的初始化，比较重要的就是<code>mcommoninit</code>函数，该函数对 m0 进行必要的初始化（前面的部分我们已经讲过了，这时 g0.m = &amp;m0）。我们详细看下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// src/runtime/proc.go#L810
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// Pre-allocated ID may be passed as &#39;id&#39;, or omitted by passing -1.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">mcommoninit</span>(mp <span style="color:#000;font-weight:bold">*</span>m, id <span style="color:#458;font-weight:bold">int64</span>) {
</span></span><span style="display:flex;"><span>	gp <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">getg</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// g0 stack won&#39;t make sense for user (and is not necessary unwindable).
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> gp <span style="color:#000;font-weight:bold">!=</span> gp.m.g0 {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">callers</span>(<span style="color:#099">1</span>, mp.createstack[:])
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#900;font-weight:bold">lock</span>(<span style="color:#000;font-weight:bold">&amp;</span>sched.lock)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 调度器初始化的时候，传进来的是 -1
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// mReserveID函数就是取 sched.mnext 的值，同时检查是否超过 10000 个工作线程的限制
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> id <span style="color:#000;font-weight:bold">&gt;=</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>		mp.id = id
</span></span><span style="display:flex;"><span>	} <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>		mp.id = <span style="color:#900;font-weight:bold">mReserveID</span>()  <span style="color:#998;font-style:italic">// m0.id = 0
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	lo <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">uint32</span>(<span style="color:#900;font-weight:bold">int64Hash</span>(<span style="color:#0086b3">uint64</span>(mp.id), fastrandseed))
</span></span><span style="display:flex;"><span>	hi <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">uint32</span>(<span style="color:#900;font-weight:bold">int64Hash</span>(<span style="color:#0086b3">uint64</span>(<span style="color:#900;font-weight:bold">cputicks</span>()), ^fastrandseed))
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> lo|hi <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>		hi = <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// Same behavior as for 1.17.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// TODO: Simplify ths.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> goarch.BigEndian {
</span></span><span style="display:flex;"><span>		mp.fastrand = <span style="color:#0086b3">uint64</span>(lo)<span style="color:#000;font-weight:bold">&lt;&lt;</span><span style="color:#099">32</span> | <span style="color:#0086b3">uint64</span>(hi)
</span></span><span style="display:flex;"><span>	} <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>		mp.fastrand = <span style="color:#0086b3">uint64</span>(hi)<span style="color:#000;font-weight:bold">&lt;&lt;</span><span style="color:#099">32</span> | <span style="color:#0086b3">uint64</span>(lo)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#900;font-weight:bold">mpreinit</span>(mp)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> mp.gsignal <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		mp.gsignal.stackguard1 = mp.gsignal.stack.lo <span style="color:#000;font-weight:bold">+</span> _StackGuard
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 把 m 挂到全局链表 allm 上
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	mp.alllink = allm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// NumCgoCall() iterates over allm w/o schedlock,
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// so we need to publish it safely.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#900;font-weight:bold">atomicstorep</span>(unsafe.<span style="color:#900;font-weight:bold">Pointer</span>(<span style="color:#000;font-weight:bold">&amp;</span>allm), unsafe.<span style="color:#900;font-weight:bold">Pointer</span>(mp))
</span></span><span style="display:flex;"><span>	<span style="color:#900;font-weight:bold">unlock</span>(<span style="color:#000;font-weight:bold">&amp;</span>sched.lock)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// Allocate memory to hold a cgo traceback if the cgo call crashes.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> iscgo <span style="color:#000;font-weight:bold">||</span> GOOS <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#34;solaris&#34;</span> <span style="color:#000;font-weight:bold">||</span> GOOS <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#34;illumos&#34;</span> <span style="color:#000;font-weight:bold">||</span> GOOS <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#34;windows&#34;</span> {
</span></span><span style="display:flex;"><span>		mp.cgoCallers = <span style="color:#0086b3">new</span>(cgoCallers)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>从函数的源代码看，这里并没有对 m0 做什么关于调度器的初始化动作，所以可以简单认为这个函数只是把 m0 放入全局链表 allm 中就返回了。</p>
<p>最重要的<code>procresize</code>函数，我们已经分析过了，详见<a href="https://www.subond.com/post/2023-08-12_gmp_p/">初始化P</a>。这里总结下该函数的主要工作：</p>
<ol>
<li>根据传入的 nproc 参数，创建这么多个 P，要么复用原来的，要么新建</li>
<li>初次启动（即初始化），完成 M0 与 P0 的关联</li>
<li>检查 allp 列表，将所有空闲的 P 放入全局空闲 P 列表，返回所有可运行的 P 列表</li>
</ol>
<p>到此，整个<code>schedinit</code>函数执行结束。此时，m0, g0 和 m 所需要的 p 完全关联在一起了。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>m0.p <span style="color:#000;font-weight:bold">=</span> allp<span style="color:#000;font-weight:bold">[</span>0<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>allp<span style="color:#000;font-weight:bold">[</span>0<span style="color:#000;font-weight:bold">]</span>.m <span style="color:#000;font-weight:bold">=</span> &amp;m0
</span></span></code></pre></td></tr></table>
</div>
</div><p>至此，调度器相关的初始化工作也基本结束了，这个时候整个调度器相关的组成部分之间的关系如下图所示：</p>
<p>
        <img class="mx-auto" alt="go_scheduler-sched_g0m0allp" src="https://wechat-1315555539.cos.ap-nanjing.myqcloud.com/uPic/go_scheduler-sched_g0m0allp.png" />   
    </p>
<h2 id="参考资料">参考资料</h2>
<ol>
<li><a href="https://mp.weixin.qq.com/s/W9D4Sl-6jYfcpczzdPfByQ">https://mp.weixin.qq.com/s/W9D4Sl-6jYfcpczzdPfByQ</a></li>
<li><a href="https://golang.design/go-questions/sched/init/">https://golang.design/go-questions/sched/init/</a></li>
</ol>

        </div>

        
<div class="post-archive">
    <ul class="post-copyright">
        <li><strong>原文作者：</strong><a rel="author" href="http://www.subond.com/">Kevin</a></li>
        <li style="word-break:break-all"><strong>原文链接：</strong><a href="http://www.subond.com/post/2023-08-23_gmp_scheduler_init/">http://www.subond.com/post/2023-08-23_gmp_scheduler_init/</a></li>
        <li><strong>版权声明：</strong>本作品采用<a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li>
    </ul>
</div>
<br/>



        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/post/2023-08-12_gmp_p/">深入理解Go调度器：如何初始化P（四）</a></li>
        
        <li><a href="/post/2023-08-07_gmp_m/">深入理解Go调度器：M 如何找工作（三）</a></li>
        
        <li><a href="/post/2023-07-25_gmp_g/">深入理解Go调度器：G 的创建（二）</a></li>
        
        <li><a href="/post/2023-07-24_gpm_gpm0/">深入理解Go调度器：初识GMP模型（一）</a></li>
        
        <li><a href="/post/2023-08-15_go_stack/">[转载]Go 语言机制之栈与指针</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/go%E8%B0%83%E5%BA%A6%E5%99%A8' target="_blank">GO调度器</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    
    

</div>

                    <footer id="footer">
    <div>
        &copy; 2023 <a href="http://www.subond.com/">凯文的个人博客 By Kevin</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://www.flysnow.org/" target="_black"><span class="badge-subject">Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>
<style type="text/css">
div.highlight {
    position: relative;
    margin: 1em 0px;
}

.copy-code {
    display: none;
    position: absolute;
    top: 4px;
    right: 4px;
    color: rgba(255, 255, 255, 0.8);
    background: rgba(78, 78, 78, 0.8);
    border-radius: var(--radius);
    padding: 0 5px;
    font: inherit;
    user-select: none;
    cursor: pointer;
    border: 0;
    --radius: 8px;
}

div.highlight:hover .copy-code,pre:hover .copy-code {
    display: block;
}

</style>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>


    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='http://www.subond.com/search' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="http://www.subond.com/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="http://www.subond.com/post/2023-09-19_zh_writing_is_magic/" title="[译]长文写作的魔力" target="_blank">[译]长文写作的魔力</a>
    </li>
    
    <li>
        <a href="http://www.subond.com/post/2023-09-08_shell_concurrency/" title="如何在 Shell 中实现并发执行" target="_blank">如何在 Shell 中实现并发执行</a>
    </li>
    
    <li>
        <a href="http://www.subond.com/post/2023-08-30_gmp_scheduler_init2/" title="深入理解Go调度器：main goroutine的创建（六）" target="_blank">深入理解Go调度器：main goroutine的创建（六）</a>
    </li>
    
    <li>
        <a href="http://www.subond.com/post/2023-08-23_gmp_scheduler_init/" title="深入理解Go调度器：调度器的初始化（五）" target="_blank">深入理解Go调度器：调度器的初始化（五）</a>
    </li>
    
    <li>
        <a href="http://www.subond.com/post/2023-08-15_go_stack/" title="[转载]Go 语言机制之栈与指针" target="_blank">[转载]Go 语言机制之栈与指针</a>
    </li>
    
    <li>
        <a href="http://www.subond.com/post/2023-08-12_gmp_p/" title="深入理解Go调度器：如何初始化P（四）" target="_blank">深入理解Go调度器：如何初始化P（四）</a>
    </li>
    
    <li>
        <a href="http://www.subond.com/post/2023-08-07_gmp_m/" title="深入理解Go调度器：M 如何找工作（三）" target="_blank">深入理解Go调度器：M 如何找工作（三）</a>
    </li>
    
    <li>
        <a href="http://www.subond.com/post/2023-08-03_selfindulgent/" title="[译文]时间和财富是如何流失的" target="_blank">[译文]时间和财富是如何流失的</a>
    </li>
    
    <li>
        <a href="http://www.subond.com/post/2023-07-31_kids/" title="[译文]养育孩子" target="_blank">[译文]养育孩子</a>
    </li>
    
    <li>
        <a href="http://www.subond.com/post/2023-07-28_wisdom/" title="[译文]智慧，是否值得？" target="_blank">[译文]智慧，是否值得？</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="http://www.subond.com/categories/go%E7%AC%94%E8%AE%B0/">Go笔记 (8)</a></li>
    
    <li><a href="http://www.subond.com/categories/go%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/">Go高性能编程 (7)</a></li>
    
    <li><a href="http://www.subond.com/categories/%E6%8A%80%E6%9C%AF/">技术 (31)</a></li>
    
    <li><a href="http://www.subond.com/categories/%E6%95%A3%E6%96%87/">散文 (10)</a></li>
    
    <li><a href="http://www.subond.com/categories/%E8%AF%91%E6%96%87%E9%9B%86/">译文集 (4)</a></li>
    
    <li><a href="http://www.subond.com/categories/%E9%B8%BF%E9%9B%81%E4%BC%A0%E4%B9%A6/">鸿雁传书 (14)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="http://www.subond.com/tags/algorithm/">algorithm</a>
    
    <a href="http://www.subond.com/tags/alignment/">alignment</a>
    
    <a href="http://www.subond.com/tags/carrer/">carrer</a>
    
    <a href="http://www.subond.com/tags/cloud/">cloud</a>
    
    <a href="http://www.subond.com/tags/defer/">defer</a>
    
    <a href="http://www.subond.com/tags/distributed-systems/">distributed systems</a>
    
    <a href="http://www.subond.com/tags/docker/">docker</a>
    
    <a href="http://www.subond.com/tags/essay/">essay</a>
    
    <a href="http://www.subond.com/tags/git/">git</a>
    
    <a href="http://www.subond.com/tags/gitbook/">gitbook</a>
    
    <a href="http://www.subond.com/tags/go/">go</a>
    
    <a href="http://www.subond.com/tags/golang/">golang</a>
    
    <a href="http://www.subond.com/tags/go%E8%B0%83%E5%BA%A6%E5%99%A8/">GO调度器</a>
    
    <a href="http://www.subond.com/tags/growth/">growth</a>
    
    <a href="http://www.subond.com/tags/life/">life</a>
    
    <a href="http://www.subond.com/tags/linux/">linux</a>
    
    <a href="http://www.subond.com/tags/mutex/">mutex</a>
    
    <a href="http://www.subond.com/tags/process/">process</a>
    
    <a href="http://www.subond.com/tags/pthread/">pthread</a>
    
    <a href="http://www.subond.com/tags/reading/">reading</a>
    
    <a href="http://www.subond.com/tags/shell/">Shell</a>
    
    <a href="http://www.subond.com/tags/slice/">slice</a>
    
    <a href="http://www.subond.com/tags/string/">string</a>
    
    <a href="http://www.subond.com/tags/struct/">struct</a>
    
    <a href="http://www.subond.com/tags/vagrant/">vagrant</a>
    
    <a href="http://www.subond.com/tags/work/">work</a>
    
    <a href="http://www.subond.com/tags/writing/">writing</a>
    
    <a href="http://www.subond.com/tags/%E4%BA%BA%E7%94%9F%E4%BF%A1%E5%BF%B5/">人生信念</a>
    
    <a href="http://www.subond.com/tags/%E5%86%85%E5%9C%A8%E8%AE%B0%E5%88%86%E7%89%8C/">内在记分牌</a>
    
    <a href="http://www.subond.com/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/">内存管理</a>
    
    <a href="http://www.subond.com/tags/%E5%86%99%E4%BD%9C/">写作</a>
    
    <a href="http://www.subond.com/tags/%E5%A4%9A%E8%BF%9B%E7%A8%8B/">多进程</a>
    
    <a href="http://www.subond.com/tags/%E5%AD%A6%E4%B9%A0/">学习</a>
    
    <a href="http://www.subond.com/tags/%E5%B9%B6%E5%8F%91/">并发</a>
    
    <a href="http://www.subond.com/tags/%E5%BF%83%E7%90%86%E5%AD%A6/">心理学</a>
    
    <a href="http://www.subond.com/tags/%E6%80%9D%E8%80%83/">思考</a>
    
    <a href="http://www.subond.com/tags/%E6%83%85%E6%84%9F/">情感</a>
    
    <a href="http://www.subond.com/tags/%E6%95%99%E8%82%B2/">教育</a>
    
    <a href="http://www.subond.com/tags/%E6%97%B6%E9%97%B4/">时间</a>
    
    <a href="http://www.subond.com/tags/%E6%99%BA%E6%85%A7/">智慧</a>
    
    <a href="http://www.subond.com/tags/%E6%A0%BC%E9%9B%B7%E5%8E%84%E5%A7%86/">格雷厄姆</a>
    
    <a href="http://www.subond.com/tags/%E7%90%86%E8%B4%A2/">理财</a>
    
    <a href="http://www.subond.com/tags/%E7%94%9F%E6%B4%BB/">生活</a>
    
    <a href="http://www.subond.com/tags/%E7%BB%8F%E6%B5%8E/">经济</a>
    
    <a href="http://www.subond.com/tags/%E7%BD%91%E7%BB%9C%E5%8D%B8%E8%BD%BD/">网络卸载</a>
    
    <a href="http://www.subond.com/tags/%E8%B4%A2%E5%AF%8C/">财富</a>
    
    <a href="http://www.subond.com/tags/%E9%87%91%E9%92%B1%E5%BF%83%E7%90%86%E5%AD%A6/">金钱心理学</a>
    
    <a href="http://www.subond.com/tags/%E9%98%85%E8%AF%BB/">阅读</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="http://github.com/yusubond" title="github">Github</a>
        </li>
        
        <li>
            <a target="_blank" href="https://weibo.cn/u/2746421033" title="微博">微博</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="http://www.subond.com/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>