<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    

    <title>深入理解Go调度器：M 如何找工作（三） | 凯文的个人博客</title>
    <meta property="og:title" content="深入理解Go调度器：M 如何找工作（三） - 凯文的个人博客">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2023-08-07T00:00:00&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2023-08-28T20:09:19&#43;08:00'>
        
    <meta name="Keywords" content="golang,博客">
    <meta name="description" content="深入理解Go调度器：M 如何找工作（三）">
        
    <meta name="author" content="Kevin">
    <meta property="og:url" content="http://www.subond.com/post/2023-08-07_gmp_m/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
    
    
    
</head>

<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="http://www.subond.com/">
                        凯文的个人博客
                    </a>
                
                <p class="description">专注于云计算网络，个人成长</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="http://www.subond.com/">首页</a>
                    
                    <a  href="http://www.subond.com/archives/" title="归档">归档</a>
                    
                    <a  href="http://www.subond.com/reading/" title="阅读">阅读</a>
                    
                    <a  href="http://www.subond.com/about/" title="关于我">关于我</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">深入理解Go调度器：M 如何找工作（三）</h1>
        </header>
        <date class="post-meta meta-date">
            2023年8月7日
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category">
                <a href='/categories/go%E7%AC%94%E8%AE%B0' target="_blank">Go笔记</a>
            </span>
            
            <span class="meta-category">
                <a href='/categories/%E6%8A%80%E6%9C%AF' target="_blank">技术</a>
            </span>
            
        </div>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span>
                    阅读</span></span>
        </div>
        
        
        <div class="post-content">
            <blockquote>
<p>本文源码基于 go 1.20.3 版本，如有问题，欢迎指出。</p>
<p>更新时间：2023.08.11</p>
<p>首次发布：2023.08.07</p>
</blockquote>
<h2 id="m-的结构">M 的结构</h2>
<p>M 是 OS 线程的实体，我们看几个比较重要的字段，包括：</p>
<ul>
<li>用于执行调度的g0</li>
<li>用于信号处理的gsignal</li>
<li>线程本地存储tls</li>
<li>当前正在运行的curg</li>
<li>执行 Goroutine 时需要的本地资源p（如果没有执行，则为nil）</li>
<li>执行系统调用前上一次绑定的oldp【结束系统调用的时候，优化恢复上一次绑定的p】</li>
<li>表示自身状态的spinning</li>
</ul>
<p>等等其他五十多个字段，包括关于 M 的调度信息、调试信息等。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// src/runtime/runtime2.go
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">type</span> m <span style="color:#000;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	g0      <span style="color:#000;font-weight:bold">*</span>g     <span style="color:#998;font-style:italic">// g0主要用来记录工作线程使用的栈信息，在执行调度代码时使用g0
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	gsignal       <span style="color:#000;font-weight:bold">*</span>g                <span style="color:#998;font-style:italic">// 用于信号处理的g
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	tls           [tlsSlots]<span style="color:#458;font-weight:bold">uintptr</span> <span style="color:#998;font-style:italic">// 工作线程本地存储
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	curg          <span style="color:#000;font-weight:bold">*</span>g       <span style="color:#998;font-style:italic">// 当前正在运行的 g，即用户创建的可运行的 g 放在这里执行
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  p             puintptr <span style="color:#998;font-style:italic">// 执行Goroutine代码时绑定的p（如果没有执行，则为nil)
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	nextp         puintptr <span style="color:#998;font-style:italic">// 【当 m 被唤醒时，首先绑定这个p】
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	oldp          puintptr <span style="color:#998;font-style:italic">// G进入系统调用前上一次绑定的p
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	spinning      <span style="color:#458;font-weight:bold">bool</span> <span style="color:#998;font-style:italic">// 自旋标志位（当 m 没有work 且 处于寻找 work 的状态）
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	incgo         <span style="color:#458;font-weight:bold">bool</span>          <span style="color:#998;font-style:italic">// m 正在执行 cgo 调用
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// 没有 g 需要运行时，工作线程休眠在这个 park 成员上
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 当有工作需要做时，其他工作线程通过 park 字段唤醒该工作线程
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  park          note
</span></span><span style="display:flex;"><span>	alllink       <span style="color:#000;font-weight:bold">*</span>m <span style="color:#998;font-style:italic">// 在 allm 上
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	freelink      <span style="color:#000;font-weight:bold">*</span>m <span style="color:#998;font-style:italic">// 在 sched.freem 上
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="m-的创建">M 的创建</h2>
<p>有两种场景需要创建 M：</p>
<ul>
<li>Go 程序启动时会创建主线程，主线程的第一个 M，即M0</li>
<li>当有新 G 创建，或者有可运行的 G，且还有空闲的 P，那么会调用 <code>starm</code>函数。<code>startm</code>函数会从 全局空闲M 队列取一个 M，和空闲的 P 绑定，执行G，如果没有空闲的M，就会通过<code>newm</code>创建一个。</li>
</ul>
<h2 id="m-的销毁">M 的销毁</h2>
<p>M 不会被销毁，但当 M 找不到工作或者找不到空闲的 P 时，会通过<code>stopm</code>进入休眠状态。那么，什么情况下会进入休眠状态呢？</p>
<p>有两种情况：</p>
<p>第一种：没有工作可做。</p>
<p>当 M 绑定的 P 没有可运行的 G 且 无法从其他 P 和 全局可运行 G 列表找到可运行的G 时，M 会尝试进入自旋状态。注意，进入自旋状态的M数量有限制，<strong>处于自旋状态的M数量最多为非空闲P的数量一半</strong>。</p>
<p>如果 M 在自旋状态没有找到可运行的 G 或者 未能进入自旋状态，就会直接进入休眠状态。【详见下面 M 如何工作部分。】</p>
<p>第二种：没有空闲的P。</p>
<p>当 M 执行的 G，进入系统调用，M 会主动与绑定的 P 解绑，当 G 退出系统调用时，M 会找一个空闲的 P 进行绑定，进而继续执行 G，但是如果找不到空闲的 P，此时 M 也会调用<code>stopm</code>进入休眠。</p>
<p><code>stopm</code>函数会将休眠的 M 放入全局的空闲队列（sched.midle），等待其他工作线程唤醒 M 时，从列表中取。</p>
<h2 id="m-的运行">M 的运行</h2>
<p>M 需要与 P 绑定才能运行，且 M 与 P 有亲和性。</p>
<p>当 M 执行的 G 进入系统调用，M 与 P 会进行解绑，M 会将当前的 P 记录到 <code>m.oldp</code> 中；当 G 退出系统调用时，M 会尝试优先绑定 <code>m.oldp</code> 中的 P。</p>
<h2 id="m-的状态">M 的状态</h2>
<p>通过前面的分析，可以知道 M 有三种状态：运行，自旋、休眠，其关系如下：</p>
<p>
        <img class="mx-auto" alt="go_scheduler-m_status" src="https://wechat-1315555539.cos.ap-nanjing.myqcloud.com/uPic/go_scheduler-m_status.png" />   
    </p>
<p>有些文章，将 M 的状态分为自旋和非自旋，主要从<code>m.spinning</code>来考虑。但笔者认为分成三种状态更易于理解，非自旋状态下，M 要么工作，要么休眠。</p>
<ul>
<li>自旋状态：当 M 没有工作，且努力找工作的时候，就是自旋</li>
<li>运行状态：M 有工作处理</li>
<li>休眠状态：M 没有工作可做，或者无法进入自旋，就会进入休眠状态</li>
</ul>
<h2 id="m-如何找工作">M 如何找工作</h2>
<p>下面，我们围绕 M 的状态，结合源码，分析下 M 是如何工作的。</p>
<p>我们知道 M 的职责就是找到一个可运行的 G，然后执行它。从大方向来讲，主要有三个过程：</p>
<ul>
<li>先从本队队列中找</li>
<li>定期从全局队列中找</li>
<li>最后去别的 P 上偷</li>
</ul>
<p>
        <img class="mx-auto" alt="go_scheduler-m_work" src="https://wechat-1315555539.cos.ap-nanjing.myqcloud.com/uPic/go_scheduler-m_work.png" />   
    </p>
<p>先看第一个过程，从 P 的本地队列找。源码分析如下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// src/runtime/proc.go
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 从本队队列寻找一个可运行的 g
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 如果 inheritTime 为真，则 gp 应该继承当前时间片的剩余时间，否则新开一个时间片
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 只有绑定的 p可执行该函数
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">runqget</span>(pp <span style="color:#000;font-weight:bold">*</span>p) (gp <span style="color:#000;font-weight:bold">*</span>g, inheritTime <span style="color:#458;font-weight:bold">bool</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// If there&#39;s a runnext, it&#39;s the next G to run.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 如果 runext 不为空，那么 runnext 就是下一个可运行的g
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	next <span style="color:#000;font-weight:bold">:=</span> pp.runnext
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// If the runnext is non-0 and the CAS fails, it could only have been stolen by another P,
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// because other Ps can race to set runnext to 0, but only the current P can set it to non-0.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// Hence, there&#39;s no need to retry this CAS if it fails.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 如果 runnext 不为空，且 cas 失败，那么 runnext 只能是被其他p偷走了
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 因为其他 p 可以将 runnext 置为零，但只有当前 p 可以将其置为非零。
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 所以，当 cas 失败后，没有必要进行重试。
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> next <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> pp.runnext.<span style="color:#900;font-weight:bold">cas</span>(next, <span style="color:#099">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// 如果找到 runnext,则返回 runnext 所指向的指针，且继承时间片
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#000;font-weight:bold">return</span> next.<span style="color:#900;font-weight:bold">ptr</span>(), <span style="color:#000;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// 取本地队列的队头
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		h <span style="color:#000;font-weight:bold">:=</span> atomic.<span style="color:#900;font-weight:bold">LoadAcq</span>(<span style="color:#000;font-weight:bold">&amp;</span>pp.runqhead) <span style="color:#998;font-style:italic">// load-acquire, synchronize with other consumers
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// 取队尾
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    t <span style="color:#000;font-weight:bold">:=</span> pp.runqtail
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> t <span style="color:#000;font-weight:bold">==</span> h {
</span></span><span style="display:flex;"><span>      <span style="color:#998;font-style:italic">// 头尾相同，说明本地队列为空，找不到g
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">nil</span>, <span style="color:#000;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// 取队头的g
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		gp <span style="color:#000;font-weight:bold">:=</span> pp.runq[h<span style="color:#000;font-weight:bold">%</span><span style="color:#0086b3">uint32</span>(<span style="color:#0086b3">len</span>(pp.runq))].<span style="color:#900;font-weight:bold">ptr</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// 原子操作，防止这中间被其他线程因偷工作而修改
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#000;font-weight:bold">if</span> atomic.<span style="color:#900;font-weight:bold">CasRel</span>(<span style="color:#000;font-weight:bold">&amp;</span>pp.runqhead, h, h<span style="color:#000;font-weight:bold">+</span><span style="color:#099">1</span>) { <span style="color:#998;font-style:italic">// cas-release, commits consume
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#000;font-weight:bold">return</span> gp, <span style="color:#000;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>整个代码还是比较简单，主要是两部分。</p>
<p>第一部分，先尝试获取 runnext，因为它的运行优先级更高。因为其他工作线程“偷工作”也是优先查看 runnext，所以这里用了原子操作。</p>
<p>第二部分，从本地队列中找。如果头尾相等，说明队列为空，直接返回。否则，取队头所指向的 g，并通过原子操作将队头指向下一个。原子操作同样为了避免其他工作线程因为“偷工作”而修改队头。</p>
<p>我们再来看第二个过程，从全局队列中获取 goroutine。需要说明的是，<code>globrunqget</code>函数的三次调用都在<code>findRunnable</code>函数中，其条件如下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// src/runtime/proc.go
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 第一次调用
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// Check the global runnable queue once in a while to ensure fairness.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// Otherwise two goroutines can completely occupy the local runqueue
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// by constantly respawning each other.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 为了公平，每调用 schedule 函数 61 次，才会从全局队列中获取 g
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">if</span> pp.schedtick<span style="color:#000;font-weight:bold">%</span><span style="color:#099">61</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> sched.runqsize &gt; <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">lock</span>(<span style="color:#000;font-weight:bold">&amp;</span>sched.lock)
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 每次最多获取 1 个 goroutine
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  gp <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">globrunqget</span>(pp, <span style="color:#099">1</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">unlock</span>(<span style="color:#000;font-weight:bold">&amp;</span>sched.lock)
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">if</span> gp <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span> gp, <span style="color:#000;font-weight:bold">false</span>, <span style="color:#000;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这说明，并不是每次调度都会从全局队列中获取可运行的 g。实际情况是调度器每调度 61 次，且全局队列有可运行的 g 时，才会调用<code>globrunqget</code>函数从全局队列中获取。因为，从全局队列中获取需要上锁，开销有些大，能不做就不做。</p>
<p>其次，每次获取最多获取 1 个可运行的 g，这是为了保证从其他工作线程也能从全局队列中获取到可运行的 g。</p>
<p>好了，我们仔细看下 <code>globrunqget</code> 函数的内容。</p>
<p>该函数的第一个参数就是当前工作线程所绑定的 P，第二个参数max表示最多可从全局队列中取多少个 G 放到当前 P 的本地队列。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// src/runtime/proc.go
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// Try get a batch of G&#39;s from the global runnable queue.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// sched.lock must be held.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 尝试从全局队列中获取可运行的 g，必须上下锁。
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 最多获取 max 个，如果 max 为零，则不限制个数。
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">globrunqget</span>(pp <span style="color:#000;font-weight:bold">*</span>p, max <span style="color:#458;font-weight:bold">int32</span>) <span style="color:#000;font-weight:bold">*</span>g {
</span></span><span style="display:flex;"><span>	<span style="color:#900;font-weight:bold">assertLockHeld</span>(<span style="color:#000;font-weight:bold">&amp;</span>sched.lock)
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 如果全局队列为空，直接返回
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> sched.runqsize <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 计算可供获取的个数 n
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 全局队列中的个数/P的个数，加1，保证最少能获取 1 个
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	n <span style="color:#000;font-weight:bold">:=</span> sched.runqsize<span style="color:#000;font-weight:bold">/</span>gomaxprocs <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> n &gt; sched.runqsize {
</span></span><span style="display:flex;"><span>		n = sched.runqsize
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 如果 max 有效，且可供获取的个数大于 max，取 max 个
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> max &gt; <span style="color:#099">0</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> n &gt; max {
</span></span><span style="display:flex;"><span>		n = max
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 最多获取 P 本地队列的一半，为了保证其他工作线程也能够获取到
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> n &gt; <span style="color:#0086b3">int32</span>(<span style="color:#0086b3">len</span>(pp.runq))<span style="color:#000;font-weight:bold">/</span><span style="color:#099">2</span> {
</span></span><span style="display:flex;"><span>		n = <span style="color:#0086b3">int32</span>(<span style="color:#0086b3">len</span>(pp.runq)) <span style="color:#000;font-weight:bold">/</span> <span style="color:#099">2</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	sched.runqsize <span style="color:#000;font-weight:bold">-=</span> n
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// 直接通过函数返回gp，其他的g通过runqput放入本地队列
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	gp <span style="color:#000;font-weight:bold">:=</span> sched.runq.<span style="color:#900;font-weight:bold">pop</span>()
</span></span><span style="display:flex;"><span>	n<span style="color:#000;font-weight:bold">--</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">for</span> ; n &gt; <span style="color:#099">0</span>; n<span style="color:#000;font-weight:bold">--</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// 继续去队头，并放入 p 的本地队列
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		gp1 <span style="color:#000;font-weight:bold">:=</span> sched.runq.<span style="color:#900;font-weight:bold">pop</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">runqput</span>(pp, gp1, <span style="color:#000;font-weight:bold">false</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 返回队头所指向的 goroutine
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">return</span> gp
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>代码还是比较好理解的。</p>
<p>先根据全局队列可运行 g 的长度和 P 的个数，计算可供获取的 g 的个数，获得一个结果。</p>
<p>然后根据参数 max 和 P 的本地可运行队列的长度一半，修正上述结果。</p>
<p>最后，从全局队列中取，放入 P 的本地队列。</p>
<p>把全局队列中可运行的 g 转移到 P 的本地队列，保证了全局队列中可运行 g 的执行机会。这是从全局队列到本地队列的负载均衡。</p>
<p><strong>知识点：</strong></p>
<p>M 从 全局队列取的 G 的数据符合下面这个公式。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#008080">n</span> <span style="color:#000;font-weight:bold">=</span> min<span style="color:#000;font-weight:bold">(</span>len<span style="color:#000;font-weight:bold">(</span>GRQ<span style="color:#000;font-weight:bold">)</span>/GOMAXPROCS + 1, len<span style="color:#000;font-weight:bold">(</span>LRQ<span style="color:#000;font-weight:bold">)</span>/2<span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后，我们看下第三个过程，从其他 P 中 “偷工作”。<code>findRunnable</code>函数只在调度函数<code>schedule</code>中出现。</p>
<p>这个函数有点长，我们一点点看。先看返回参数有三个：</p>
<ul>
<li>gp，即可运行的 goroutine，这是寻找的目标</li>
<li>inheritTime，同上面介绍的一样，即是否需要继承时间片</li>
<li>tryWakeP，表示 g 所在的 P 需要被唤醒</li>
</ul>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">137
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">138
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">139
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">140
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">141
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">142
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">143
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">144
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">145
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">146
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">147
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">148
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">149
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">150
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">151
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">152
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">153
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">154
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">155
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">156
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">157
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">158
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">159
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">160
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">161
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">162
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">163
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">164
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">165
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">166
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">167
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">168
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">169
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">170
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">171
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">172
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">173
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">174
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">175
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">176
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">177
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">178
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">179
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">180
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">181
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">182
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">183
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">184
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">185
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">186
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">187
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">188
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">189
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">190
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">191
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">192
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">193
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">194
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">195
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">196
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">197
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">198
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">199
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">200
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">201
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">202
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">203
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">204
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">205
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">206
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">207
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">208
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">209
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">210
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">211
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">212
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">213
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">214
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">215
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">216
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">217
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">218
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">219
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">220
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">221
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">222
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">223
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">224
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">225
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">226
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">227
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">228
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">229
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">230
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">231
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">232
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">233
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">234
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">235
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">236
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">237
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">238
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">239
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">240
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">241
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">242
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">243
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">244
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">245
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">246
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">247
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">248
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">249
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">250
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">251
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">252
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">253
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">254
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">255
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">256
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">257
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">258
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">259
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">260
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">261
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">262
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">263
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">264
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">265
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">266
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">267
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">268
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">269
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">270
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">271
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">272
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">273
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">274
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">275
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">276
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">277
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">278
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">279
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">280
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">281
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">282
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">283
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">284
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">285
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">286
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">287
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">288
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">289
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">290
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">291
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">292
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">293
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">294
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">295
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">296
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">297
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">298
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">299
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">300
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">301
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">302
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">303
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">304
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">305
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">306
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">307
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">308
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">309
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">310
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">311
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">312
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">313
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">314
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">315
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">316
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">317
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">318
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">319
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">320
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">321
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">322
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">323
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">324
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">325
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">326
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">327
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">328
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">329
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">330
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">331
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">332
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">333
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">334
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">335
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">336
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">337
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">338
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">339
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">340
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">341
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">342
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">343
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">344
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">345
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">346
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">347
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">348
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">349
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">350
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">351
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">352
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">353
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">354
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">355
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">356
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">357
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">358
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">359
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">360
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// src/runtime/proc.go 
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// Finds a runnable goroutine to execute.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// Tries to steal from other P&#39;s, get g from local or global queue, poll network.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// tryWakeP indicates that the returned goroutine is not normal (GC worker, trace
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// reader) so the caller should try to wake a P.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">findRunnable</span>() (gp <span style="color:#000;font-weight:bold">*</span>g, inheritTime, tryWakeP <span style="color:#458;font-weight:bold">bool</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 当前 g 所在的 m
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	mp <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">getg</span>().m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// The conditions here and in handoffp must agree: if
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// findrunnable would return a G to run, handoffp must start
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// an M.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span>top:
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 还记得吗？m 结构中的 p 表示 m 执行go代码时所绑定的p
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	pp <span style="color:#000;font-weight:bold">:=</span> mp.p.<span style="color:#900;font-weight:bold">ptr</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> sched.gcwaiting.<span style="color:#900;font-weight:bold">Load</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">gcstopm</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">goto</span> top
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> pp.runSafePointFn <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">runSafePointFn</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// now and pollUntil are saved for work stealing later,
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// which may steal timers. It&#39;s important that between now
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// and then, nothing blocks, so these numbers remain mostly
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// relevant.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	now, pollUntil, _ <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">checkTimers</span>(pp, <span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// Try to schedule the trace reader.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> trace.enabled <span style="color:#000;font-weight:bold">||</span> trace.shutdown {
</span></span><span style="display:flex;"><span>		gp <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">traceReader</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> gp <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#900;font-weight:bold">casgstatus</span>(gp, _Gwaiting, _Grunnable)
</span></span><span style="display:flex;"><span>			<span style="color:#900;font-weight:bold">traceGoUnpark</span>(gp, <span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span> gp, <span style="color:#000;font-weight:bold">false</span>, <span style="color:#000;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// Try to schedule a GC worker.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 尝试调度 gc 工作线程，如果找到可运行的gc线程，返回gc线程
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> gcBlackenEnabled <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>		gp, tnow <span style="color:#000;font-weight:bold">:=</span> gcController.<span style="color:#900;font-weight:bold">findRunnableGCWorker</span>(pp, now)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> gp <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span> gp, <span style="color:#000;font-weight:bold">false</span>, <span style="color:#000;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		now = tnow
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// Check the global runnable queue once in a while to ensure fairness.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// Otherwise two goroutines can completely occupy the local runqueue
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// by constantly respawning each other.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 这里前面介绍了，为了保证公平，定期地检查全局队列
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 一定是调度 61 次 且 全局队列不为空，才会调用globrunqget，
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 而且最多从全局队列中拿 1 个
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> pp.schedtick<span style="color:#000;font-weight:bold">%</span><span style="color:#099">61</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> sched.runqsize &gt; <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">lock</span>(<span style="color:#000;font-weight:bold">&amp;</span>sched.lock)
</span></span><span style="display:flex;"><span>		gp <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">globrunqget</span>(pp, <span style="color:#099">1</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">unlock</span>(<span style="color:#000;font-weight:bold">&amp;</span>sched.lock)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> gp <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span> gp, <span style="color:#000;font-weight:bold">false</span>, <span style="color:#000;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// Wake up the finalizer G.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> fingStatus.<span style="color:#900;font-weight:bold">Load</span>()<span style="color:#000;font-weight:bold">&amp;</span>(fingWait|fingWake) <span style="color:#000;font-weight:bold">==</span> fingWait|fingWake {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> gp <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">wakefing</span>(); gp <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#900;font-weight:bold">ready</span>(gp, <span style="color:#099">0</span>, <span style="color:#000;font-weight:bold">true</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">*</span>cgo_yield <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">asmcgocall</span>(<span style="color:#000;font-weight:bold">*</span>cgo_yield, <span style="color:#000;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// local runq
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 从 p 的本地队列中寻找，如果找到，直接返回
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> gp, inheritTime <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">runqget</span>(pp); gp <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> gp, inheritTime, <span style="color:#000;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// global runq
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 这里是，只要全局队列不为空，就从全局队列中拿，且不限制个数
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> sched.runqsize <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">lock</span>(<span style="color:#000;font-weight:bold">&amp;</span>sched.lock)
</span></span><span style="display:flex;"><span>		gp <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">globrunqget</span>(pp, <span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">unlock</span>(<span style="color:#000;font-weight:bold">&amp;</span>sched.lock)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> gp <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span> gp, <span style="color:#000;font-weight:bold">false</span>, <span style="color:#000;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// Poll network.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// This netpoll is only an optimization before we resort to stealing.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// We can safely skip it if there are no waiters or a thread is blocked
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// in netpoll already. If there is any kind of logical race with that
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// blocked thread (e.g. it has already returned from netpoll, but does
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// not set lastpoll yet), this thread will do blocking netpoll below
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// anyway.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> <span style="color:#900;font-weight:bold">netpollinited</span>() <span style="color:#000;font-weight:bold">&amp;&amp;</span> netpollWaiters.<span style="color:#900;font-weight:bold">Load</span>() &gt; <span style="color:#099">0</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> sched.lastpoll.<span style="color:#900;font-weight:bold">Load</span>() <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> list <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">netpoll</span>(<span style="color:#099">0</span>); !list.<span style="color:#900;font-weight:bold">empty</span>() { <span style="color:#998;font-style:italic">// non-blocking
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			gp <span style="color:#000;font-weight:bold">:=</span> list.<span style="color:#900;font-weight:bold">pop</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#900;font-weight:bold">injectglist</span>(<span style="color:#000;font-weight:bold">&amp;</span>list)
</span></span><span style="display:flex;"><span>			<span style="color:#900;font-weight:bold">casgstatus</span>(gp, _Gwaiting, _Grunnable)
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> trace.enabled {
</span></span><span style="display:flex;"><span>				<span style="color:#900;font-weight:bold">traceGoUnpark</span>(gp, <span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span> gp, <span style="color:#000;font-weight:bold">false</span>, <span style="color:#000;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// Spinning Ms: steal work from other Ps.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// Limit the number of spinning Ms to half the number of busy Ps.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// This is necessary to prevent excessive CPU consumption when
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// GOMAXPROCS&gt;&gt;1 but the program parallelism is low.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 如果 m 为自旋状态，或者 自旋m数小于忙碌的p个数一半
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> mp.spinning <span style="color:#000;font-weight:bold">||</span> <span style="color:#099">2</span><span style="color:#000;font-weight:bold">*</span>sched.nmspinning.<span style="color:#900;font-weight:bold">Load</span>() &lt; gomaxprocs<span style="color:#000;font-weight:bold">-</span>sched.npidle.<span style="color:#900;font-weight:bold">Load</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> !mp.spinning {
</span></span><span style="display:flex;"><span>			mp.<span style="color:#900;font-weight:bold">becomeSpinning</span>()
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		gp, inheritTime, tnow, w, newWork <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">stealWork</span>(now)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> gp <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">// Successfully stole.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>      <span style="color:#998;font-style:italic">// 成功&#34;偷到工作“，那么直接返回
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#000;font-weight:bold">return</span> gp, inheritTime, <span style="color:#000;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> newWork {
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">// There may be new timer or GC work; restart to
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#998;font-style:italic">// discover.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#000;font-weight:bold">goto</span> top
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		now = tnow
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> w <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> (pollUntil <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span> <span style="color:#000;font-weight:bold">||</span> w &lt; pollUntil) {
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">// Earlier timer to wait for.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			pollUntil = w
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// We have nothing to do.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// If we&#39;re in the GC mark phase, can safely scan and blacken objects,
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// and have work to do, run idle-time marking rather than give up the P.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> gcBlackenEnabled <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#900;font-weight:bold">gcMarkWorkAvailable</span>(pp) <span style="color:#000;font-weight:bold">&amp;&amp;</span> gcController.<span style="color:#900;font-weight:bold">addIdleMarkWorker</span>() {
</span></span><span style="display:flex;"><span>		node <span style="color:#000;font-weight:bold">:=</span> (<span style="color:#000;font-weight:bold">*</span>gcBgMarkWorkerNode)(gcBgMarkWorkerPool.<span style="color:#900;font-weight:bold">pop</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> node <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			pp.gcMarkWorkerMode = gcMarkWorkerIdleMode
</span></span><span style="display:flex;"><span>			gp <span style="color:#000;font-weight:bold">:=</span> node.gp.<span style="color:#900;font-weight:bold">ptr</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#900;font-weight:bold">casgstatus</span>(gp, _Gwaiting, _Grunnable)
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> trace.enabled {
</span></span><span style="display:flex;"><span>				<span style="color:#900;font-weight:bold">traceGoUnpark</span>(gp, <span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span> gp, <span style="color:#000;font-weight:bold">false</span>, <span style="color:#000;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		gcController.<span style="color:#900;font-weight:bold">removeIdleMarkWorker</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// wasm only:
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// If a callback returned and no other goroutine is awake,
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// then wake event handler goroutine which pauses execution
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// until a callback was triggered.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	gp, otherReady <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">beforeIdle</span>(now, pollUntil)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> gp <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">casgstatus</span>(gp, _Gwaiting, _Grunnable)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> trace.enabled {
</span></span><span style="display:flex;"><span>			<span style="color:#900;font-weight:bold">traceGoUnpark</span>(gp, <span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> gp, <span style="color:#000;font-weight:bold">false</span>, <span style="color:#000;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> otherReady {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">goto</span> top
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// Before we drop our P, make a snapshot of the allp slice,
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// which can change underfoot once we no longer block
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// safe-points. We don&#39;t need to snapshot the contents because
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// everything up to cap(allp) is immutable.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	allpSnapshot <span style="color:#000;font-weight:bold">:=</span> allp
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// Also snapshot masks. Value changes are OK, but we can&#39;t allow
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// len to change out from under us.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	idlepMaskSnapshot <span style="color:#000;font-weight:bold">:=</span> idlepMask
</span></span><span style="display:flex;"><span>	timerpMaskSnapshot <span style="color:#000;font-weight:bold">:=</span> timerpMask
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// return P and block
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#900;font-weight:bold">lock</span>(<span style="color:#000;font-weight:bold">&amp;</span>sched.lock)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> sched.gcwaiting.<span style="color:#900;font-weight:bold">Load</span>() <span style="color:#000;font-weight:bold">||</span> pp.runSafePointFn <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">unlock</span>(<span style="color:#000;font-weight:bold">&amp;</span>sched.lock)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">goto</span> top
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> sched.runqsize <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>		gp <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">globrunqget</span>(pp, <span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">unlock</span>(<span style="color:#000;font-weight:bold">&amp;</span>sched.lock)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> gp, <span style="color:#000;font-weight:bold">false</span>, <span style="color:#000;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> !mp.spinning <span style="color:#000;font-weight:bold">&amp;&amp;</span> sched.needspinning.<span style="color:#900;font-weight:bold">Load</span>() <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">1</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">// See &#34;Delicate dance&#34; comment below.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		mp.<span style="color:#900;font-weight:bold">becomeSpinning</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">unlock</span>(<span style="color:#000;font-weight:bold">&amp;</span>sched.lock)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">goto</span> top
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 当前工作线程解除与 p 的绑定关系，准备去休眠
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> <span style="color:#900;font-weight:bold">releasep</span>() <span style="color:#000;font-weight:bold">!=</span> pp {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">throw</span>(<span style="color:#d14">&#34;findrunnable: wrong p&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 将 p 放入空闲队列
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	now = <span style="color:#900;font-weight:bold">pidleput</span>(pp, now)
</span></span><span style="display:flex;"><span>	<span style="color:#900;font-weight:bold">unlock</span>(<span style="color:#000;font-weight:bold">&amp;</span>sched.lock)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// Delicate dance: thread transitions from spinning to non-spinning
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// state, potentially concurrently with submission of new work. We must
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// drop nmspinning first and then check all sources again (with
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// #StoreLoad memory barrier in between). If we do it the other way
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// around, another thread can submit work after we&#39;ve checked all
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// sources but before we drop nmspinning; as a result nobody will
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// unpark a thread to run the work.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// This applies to the following sources of work:
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// * Goroutines added to a per-P run queue.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// * New/modified-earlier timers on a per-P timer heap.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// * Idle-priority GC work (barring golang.org/issue/19112).
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// If we discover new work below, we need to restore m.spinning as a
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// signal for resetspinning to unpark a new worker thread (because
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// there can be more than one starving goroutine).
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// However, if after discovering new work we also observe no idle Ps
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// (either here or in resetspinning), we have a problem. We may be
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// racing with a non-spinning M in the block above, having found no
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// work and preparing to release its P and park. Allowing that P to go
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// idle will result in loss of work conservation (idle P while there is
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// runnable work). This could result in complete deadlock in the
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// unlikely event that we discover new work (from netpoll) right as we
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// are racing with _all_ other Ps going idle.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// We use sched.needspinning to synchronize with non-spinning Ms going
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// idle. If needspinning is set when they are about to drop their P,
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// they abort the drop and instead become a new spinning M on our
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// behalf. If we are not racing and the system is truly fully loaded
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// then no spinning threads are required, and the next thread to
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// naturally become spinning will clear the flag.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// Also see &#34;Worker thread parking/unparking&#34; comment at the top of the
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// file.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	wasSpinning <span style="color:#000;font-weight:bold">:=</span> mp.spinning
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 如果自旋状态下实在没有工作做，那么置为 非自旋，全局自旋m数减一
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> mp.spinning {
</span></span><span style="display:flex;"><span>		mp.spinning = <span style="color:#000;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> sched.nmspinning.<span style="color:#900;font-weight:bold">Add</span>(<span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>) &lt; <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#900;font-weight:bold">throw</span>(<span style="color:#d14">&#34;findrunnable: negative nmspinning&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">// Note the for correctness, only the last M transitioning from
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// spinning to non-spinning must perform these rechecks to
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// ensure no missed work. However, the runtime has some cases
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// of transient increments of nmspinning that are decremented
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// without going through this path, so we must be conservative
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// and perform the check on all spinning Ms.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// See https://go.dev/issue/43997.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">// Check all runqueues once again.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// 休眠之前，为了确保没有错过工作要做，当 m 从自旋状态进入非自旋状态，再次检查一遍所有的p
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// 如果发现有工作要做，回到自旋状态，重新寻找
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		pp <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">checkRunqsNoP</span>(allpSnapshot, idlepMaskSnapshot)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> pp <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#900;font-weight:bold">acquirep</span>(pp)
</span></span><span style="display:flex;"><span>			mp.<span style="color:#900;font-weight:bold">becomeSpinning</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">goto</span> top
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">// Check for idle-priority GC work again.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// 如果找到空闲的 gc 工作，则运行 gc 工作
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		pp, gp <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">checkIdleGCNoP</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> pp <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#900;font-weight:bold">acquirep</span>(pp)
</span></span><span style="display:flex;"><span>			mp.<span style="color:#900;font-weight:bold">becomeSpinning</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">// Run the idle worker.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			pp.gcMarkWorkerMode = gcMarkWorkerIdleMode
</span></span><span style="display:flex;"><span>			<span style="color:#900;font-weight:bold">casgstatus</span>(gp, _Gwaiting, _Grunnable)
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> trace.enabled {
</span></span><span style="display:flex;"><span>				<span style="color:#900;font-weight:bold">traceGoUnpark</span>(gp, <span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span> gp, <span style="color:#000;font-weight:bold">false</span>, <span style="color:#000;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">// Finally, check for timer creation or expiry concurrently with
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// transitioning from spinning to non-spinning.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// Note that we cannot use checkTimers here because it calls
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// adjusttimers which may need to allocate memory, and that isn&#39;t
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// allowed when we don&#39;t have an active P.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		pollUntil = <span style="color:#900;font-weight:bold">checkTimersNoP</span>(allpSnapshot, timerpMaskSnapshot, pollUntil)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// Poll network until next timer.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> <span style="color:#900;font-weight:bold">netpollinited</span>() <span style="color:#000;font-weight:bold">&amp;&amp;</span> (netpollWaiters.<span style="color:#900;font-weight:bold">Load</span>() &gt; <span style="color:#099">0</span> <span style="color:#000;font-weight:bold">||</span> pollUntil <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span>) <span style="color:#000;font-weight:bold">&amp;&amp;</span> sched.lastpoll.<span style="color:#900;font-weight:bold">Swap</span>(<span style="color:#099">0</span>) <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>		sched.pollUntil.<span style="color:#900;font-weight:bold">Store</span>(pollUntil)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> mp.p <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#900;font-weight:bold">throw</span>(<span style="color:#d14">&#34;findrunnable: netpoll with p&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> mp.spinning {
</span></span><span style="display:flex;"><span>			<span style="color:#900;font-weight:bold">throw</span>(<span style="color:#d14">&#34;findrunnable: netpoll with spinning&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">// Refresh now.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		now = <span style="color:#900;font-weight:bold">nanotime</span>()
</span></span><span style="display:flex;"><span>		delay <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">int64</span>(<span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> pollUntil <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>			delay = pollUntil <span style="color:#000;font-weight:bold">-</span> now
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> delay &lt; <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>				delay = <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> faketime <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">// When using fake time, just poll.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			delay = <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		list <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">netpoll</span>(delay) <span style="color:#998;font-style:italic">// block until new work is available
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		sched.pollUntil.<span style="color:#900;font-weight:bold">Store</span>(<span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>		sched.lastpoll.<span style="color:#900;font-weight:bold">Store</span>(now)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> faketime <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> list.<span style="color:#900;font-weight:bold">empty</span>() {
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">// Using fake time and nothing is ready; stop M.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#998;font-style:italic">// When all M&#39;s stop, checkdead will call timejump.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#900;font-weight:bold">stopm</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">goto</span> top
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">lock</span>(<span style="color:#000;font-weight:bold">&amp;</span>sched.lock)
</span></span><span style="display:flex;"><span>		pp, _ <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">pidleget</span>(now)
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">unlock</span>(<span style="color:#000;font-weight:bold">&amp;</span>sched.lock)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> pp <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#900;font-weight:bold">injectglist</span>(<span style="color:#000;font-weight:bold">&amp;</span>list)
</span></span><span style="display:flex;"><span>		} <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#900;font-weight:bold">acquirep</span>(pp)
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> !list.<span style="color:#900;font-weight:bold">empty</span>() {
</span></span><span style="display:flex;"><span>				gp <span style="color:#000;font-weight:bold">:=</span> list.<span style="color:#900;font-weight:bold">pop</span>()
</span></span><span style="display:flex;"><span>				<span style="color:#900;font-weight:bold">injectglist</span>(<span style="color:#000;font-weight:bold">&amp;</span>list)
</span></span><span style="display:flex;"><span>				<span style="color:#900;font-weight:bold">casgstatus</span>(gp, _Gwaiting, _Grunnable)
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">if</span> trace.enabled {
</span></span><span style="display:flex;"><span>					<span style="color:#900;font-weight:bold">traceGoUnpark</span>(gp, <span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">return</span> gp, <span style="color:#000;font-weight:bold">false</span>, <span style="color:#000;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> wasSpinning {
</span></span><span style="display:flex;"><span>				mp.<span style="color:#900;font-weight:bold">becomeSpinning</span>()
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">goto</span> top
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	} <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> pollUntil <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#900;font-weight:bold">netpollinited</span>() {
</span></span><span style="display:flex;"><span>		pollerPollUntil <span style="color:#000;font-weight:bold">:=</span> sched.pollUntil.<span style="color:#900;font-weight:bold">Load</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> pollerPollUntil <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span> <span style="color:#000;font-weight:bold">||</span> pollerPollUntil &gt; pollUntil {
</span></span><span style="display:flex;"><span>			<span style="color:#900;font-weight:bold">netpollBreak</span>()
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// m 进入休眠状态
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#900;font-weight:bold">stopm</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">goto</span> top
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这部分最能说明 M 找工作的精神：尽力从本地队列 或 全局队列中寻找工作，如果实在找不到再进入休眠状态，等待有工作时，被其他 M 唤醒。</p>
<p>另外，阅读这部分源码需要注意每个<code>return</code>的部分。先看前两个。</p>
<p>第一个地方，如果找到 traceReader，则直接trace工作。这说明 trace 优先级最高。</p>
<p>第二个地方，检查 gc 工作，如果有，则执行 gc 工作。</p>
<p>紧接着，先周期性地检查全局队列。</p>
<p>然后，先从 p 本地队列找寻找 goroutine，如果找不到，再去全局队列中寻找；实在找不到，就只能去”偷“了。</p>
<p>为了避免 <code>GOMAXPROCS</code>很大，但程序并发很小情况下，过多的 m 进入自旋状态，所以限制了 自旋状态的个数，不超过 忙碌 P 的一半。</p>
<p>如果成功”偷“到了，那么执行偷来的工作。</p>
<p>如果没有偷到呢？如果没偷到，依然有工作可以做。</p>
<p>如果当前正处在 gc 的标记阶段，那么安全地扫描和标记对象，所以依然有工作可以做。看看人家这是什么精神。</p>
<p>如果依然没有工作要做，在放弃 P 之前，对所有的 P 做一次快照。</p>
<p>然后，才释放P，将其放入空闲队列。</p>
<p>如果 M 是自旋状态，那么再次检查所有的可运行队列，检查「空闲优先级」的 gc 工作。</p>
<p>如果没有工作可做，才会 stopm。</p>
<p>整个过程的流程图如下。</p>
<p>
        <img class="mx-auto" alt="go_scheduler_findrunable" src="https://wechat-1315555539.cos.ap-nanjing.myqcloud.com/uPic/go_scheduler_findrunable.png" />   
    </p>
<p>这个过程涉及三个关键点，分别是”怎么偷“，”解除 P 与 M 的关联“，以及“进入休眠”。</p>
<p><strong>怎么偷</strong></p>
<p>我们看下<code>stealWork</code>函数的源码。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// src/runtime/proc.go
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// stealWork attempts to steal a runnable goroutine or timer from any P.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 尝试从任何一个 P 中偷一个可运行的 G 或者 时间
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// If newWork is true, new work may have been readied.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// If now is not 0 it is the current time. stealWork returns the passed time or
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// the current time if now was passed as 0.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 尝试从任何一个 P 中偷一个可运行的 G 或者 时间.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 如果 newWork 为真，表示有可运行的 G.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">stealWork</span>(now <span style="color:#458;font-weight:bold">int64</span>) (gp <span style="color:#000;font-weight:bold">*</span>g, inheritTime <span style="color:#458;font-weight:bold">bool</span>, rnow, pollUntil <span style="color:#458;font-weight:bold">int64</span>, newWork <span style="color:#458;font-weight:bold">bool</span>) {
</span></span><span style="display:flex;"><span>	pp <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">getg</span>().m.p.<span style="color:#900;font-weight:bold">ptr</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	ranTimer <span style="color:#000;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">const</span> stealTries = <span style="color:#099">4</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">for</span> i <span style="color:#000;font-weight:bold">:=</span> <span style="color:#099">0</span>; i &lt; stealTries; i<span style="color:#000;font-weight:bold">++</span> {
</span></span><span style="display:flex;"><span>		stealTimersOrRunNextG <span style="color:#000;font-weight:bold">:=</span> i <span style="color:#000;font-weight:bold">==</span> stealTries<span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">for</span> enum <span style="color:#000;font-weight:bold">:=</span> stealOrder.<span style="color:#900;font-weight:bold">start</span>(<span style="color:#900;font-weight:bold">fastrand</span>()); !enum.<span style="color:#900;font-weight:bold">done</span>(); enum.<span style="color:#900;font-weight:bold">next</span>() {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> sched.gcwaiting.<span style="color:#900;font-weight:bold">Load</span>() {
</span></span><span style="display:flex;"><span>				<span style="color:#998;font-style:italic">// GC work may be available.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>				<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">nil</span>, <span style="color:#000;font-weight:bold">false</span>, now, pollUntil, <span style="color:#000;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			p2 <span style="color:#000;font-weight:bold">:=</span> allp[enum.<span style="color:#900;font-weight:bold">position</span>()]
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> pp <span style="color:#000;font-weight:bold">==</span> p2 {
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">// Steal timers from p2. This call to checkTimers is the only place
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#998;font-style:italic">// where we might hold a lock on a different P&#39;s timers. We do this
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#998;font-style:italic">// once on the last pass before checking runnext because stealing
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#998;font-style:italic">// from the other P&#39;s runnext should be the last resort, so if there
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#998;font-style:italic">// are timers to steal do that first.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#998;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#998;font-style:italic">// We only check timers on one of the stealing iterations because
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#998;font-style:italic">// the time stored in now doesn&#39;t change in this loop and checking
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#998;font-style:italic">// the timers for each P more than once with the same value of now
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#998;font-style:italic">// is probably a waste of time.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#998;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#998;font-style:italic">// timerpMask tells us whether the P may have timers at all. If it
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#998;font-style:italic">// can&#39;t, no need to check at all.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#000;font-weight:bold">if</span> stealTimersOrRunNextG <span style="color:#000;font-weight:bold">&amp;&amp;</span> timerpMask.<span style="color:#900;font-weight:bold">read</span>(enum.<span style="color:#900;font-weight:bold">position</span>()) {
</span></span><span style="display:flex;"><span>				tnow, w, ran <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">checkTimers</span>(p2, now)
</span></span><span style="display:flex;"><span>				now = tnow
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">if</span> w <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> (pollUntil <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span> <span style="color:#000;font-weight:bold">||</span> w &lt; pollUntil) {
</span></span><span style="display:flex;"><span>					pollUntil = w
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">if</span> ran {
</span></span><span style="display:flex;"><span>					<span style="color:#998;font-style:italic">// Running the timers may have
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>					<span style="color:#998;font-style:italic">// made an arbitrary number of G&#39;s
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>					<span style="color:#998;font-style:italic">// ready and added them to this P&#39;s
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>					<span style="color:#998;font-style:italic">// local run queue. That invalidates
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>					<span style="color:#998;font-style:italic">// the assumption of runqsteal
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>					<span style="color:#998;font-style:italic">// that it always has room to add
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>					<span style="color:#998;font-style:italic">// stolen G&#39;s. So check now if there
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>					<span style="color:#998;font-style:italic">// is a local G to run.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>					<span style="color:#000;font-weight:bold">if</span> gp, inheritTime <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">runqget</span>(pp); gp <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>						<span style="color:#000;font-weight:bold">return</span> gp, inheritTime, now, pollUntil, ranTimer
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					ranTimer = <span style="color:#000;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">// Don&#39;t bother to attempt to steal if p2 is idle.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#000;font-weight:bold">if</span> !idlepMask.<span style="color:#900;font-weight:bold">read</span>(enum.<span style="color:#900;font-weight:bold">position</span>()) {
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">if</span> gp <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">runqsteal</span>(pp, p2, stealTimersOrRunNextG); gp <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#000;font-weight:bold">return</span> gp, <span style="color:#000;font-weight:bold">false</span>, now, pollUntil, ranTimer
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// No goroutines found to steal. Regardless, running a timer may have
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// made some goroutine ready that we missed. Indicate the next timer to
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// wait for.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">nil</span>, <span style="color:#000;font-weight:bold">false</span>, now, pollUntil, ranTimer
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>从函数可以看到这样几点：</p>
<ul>
<li>最多尝试偷4次，即第一个 for 循环</li>
<li>从其他 P “偷工作”也是通过<code>runqget</code>函数，只不过传入的参数为其他 P</li>
</ul>
<p><strong>解除 P 与 M 的关联</strong></p>
<p>当实在没有工作可做是，就会解除与 P 的绑定，我们看下<code>releasep</code>函数，解除绑定都做了啥。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// src/runtime/proc.go
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// Disassociate p and the current m.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">releasep</span>() <span style="color:#000;font-weight:bold">*</span>p {
</span></span><span style="display:flex;"><span>	gp <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">getg</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> gp.m.p <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">throw</span>(<span style="color:#d14">&#34;releasep: invalid arg&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	pp <span style="color:#000;font-weight:bold">:=</span> gp.m.p.<span style="color:#900;font-weight:bold">ptr</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> pp.m.<span style="color:#900;font-weight:bold">ptr</span>() <span style="color:#000;font-weight:bold">!=</span> gp.m <span style="color:#000;font-weight:bold">||</span> pp.status <span style="color:#000;font-weight:bold">!=</span> _Prunning {
</span></span><span style="display:flex;"><span>		<span style="color:#0086b3">print</span>(<span style="color:#d14">&#34;releasep: m=&#34;</span>, gp.m, <span style="color:#d14">&#34; m-&gt;p=&#34;</span>, gp.m.p.<span style="color:#900;font-weight:bold">ptr</span>(), <span style="color:#d14">&#34; p-&gt;m=&#34;</span>, <span style="color:#900;font-weight:bold">hex</span>(pp.m), <span style="color:#d14">&#34; p-&gt;status=&#34;</span>, pp.status, <span style="color:#d14">&#34;\n&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">throw</span>(<span style="color:#d14">&#34;releasep: invalid p state&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> trace.enabled {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">traceProcStop</span>(gp.m.p.<span style="color:#900;font-weight:bold">ptr</span>())
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 将各自的引用都置为零
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	gp.m.p = <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>	pp.m = <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>	pp.status = _Pidle <span style="color:#998;font-style:italic">// 将 P 标记为 Pidle 状态
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">return</span> pp
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>前面都是一些合法性校验，主要工作就是将 M/P 互相引用的字段清空，并将 P 的状态置为<code>_Pidle</code>。</p>
<p>一旦释放P，P 变为空闲状态，进而会放入全局的空闲列表。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// src/runtime/proc.go
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 将 P 放到 空闲列表
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">pidleput</span>(pp <span style="color:#000;font-weight:bold">*</span>p, now <span style="color:#458;font-weight:bold">int64</span>) <span style="color:#458;font-weight:bold">int64</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#900;font-weight:bold">assertLockHeld</span>(<span style="color:#000;font-weight:bold">&amp;</span>sched.lock)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> !<span style="color:#900;font-weight:bold">runqempty</span>(pp) {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">throw</span>(<span style="color:#d14">&#34;pidleput: P has non-empty run queue&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> now <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>		now = <span style="color:#900;font-weight:bold">nanotime</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#900;font-weight:bold">updateTimerPMask</span>(pp) <span style="color:#998;font-style:italic">// clear if there are no timers.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	idlepMask.<span style="color:#900;font-weight:bold">set</span>(pp.id)
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 将 p.link 指向 sched.pidle所指向的 p，也就是空闲列表的第一个p
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	pp.link = sched.pidle
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 更新 sched.pidle
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	sched.pidle.<span style="color:#900;font-weight:bold">set</span>(pp)
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 全局空闲 p 数量加1
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	sched.npidle.<span style="color:#900;font-weight:bold">Add</span>(<span style="color:#099">1</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> !pp.limiterEvent.<span style="color:#900;font-weight:bold">start</span>(limiterEventIdle, now) {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">throw</span>(<span style="color:#d14">&#34;must be able to track idle limiter event&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> now
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>所有的空闲 p 以链表的方式存储。整个构造过程是，先讲 p.link 指向 sched.pidle（表头）所指向的 p，然后在更新 sched.pidle，使其指向当前 p，这样链表就构造完成了。</p>
<p><strong>进入休眠</strong></p>
<p>接下来，要进入休眠了，这部分主要是<code>stopm</code>函数</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 休眠，要停止执行工作，
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// src/routime/proc.go
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 停止执行工作，直到有新的工作可做为止。
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">stopm</span>() {
</span></span><span style="display:flex;"><span>	gp <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">getg</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> gp.m.locks <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">throw</span>(<span style="color:#d14">&#34;stopm holding locks&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> gp.m.p <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">throw</span>(<span style="color:#d14">&#34;stopm holding p&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> gp.m.spinning {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">throw</span>(<span style="color:#d14">&#34;stopm spinning&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 上锁，将 m 放到全局空闲队列中，下锁
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#900;font-weight:bold">lock</span>(<span style="color:#000;font-weight:bold">&amp;</span>sched.lock)
</span></span><span style="display:flex;"><span>	<span style="color:#900;font-weight:bold">mput</span>(gp.m)
</span></span><span style="display:flex;"><span>	<span style="color:#900;font-weight:bold">unlock</span>(<span style="color:#000;font-weight:bold">&amp;</span>sched.lock)
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// m 进入休眠
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#900;font-weight:bold">mPark</span>()
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 将 m 与 nextp 关联起来，前面讲过，m 被唤醒后，首先绑定nextp，所以这里关联一下
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#900;font-weight:bold">acquirep</span>(gp.m.nextp.<span style="color:#900;font-weight:bold">ptr</span>())
</span></span><span style="display:flex;"><span>	gp.m.nextp = <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>mPark</code>里面就两个函数，<code>notesleep</code>函数使当前工作线程进入休眠状态。其他工作线程在检测到“当前有很多工作要做”，会调用<code>noteclear</code>将其唤醒。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">mPark</span>() {
</span></span><span style="display:flex;"><span>	gp <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">getg</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#900;font-weight:bold">notesleep</span>(<span style="color:#000;font-weight:bold">&amp;</span>gp.m.park)
</span></span><span style="display:flex;"><span>	<span style="color:#900;font-weight:bold">noteclear</span>(<span style="color:#000;font-weight:bold">&amp;</span>gp.m.park)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>还记得 park 字段吗？它是一个<code>note</code>，结构很简单只有一个<code>key</code>字段。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">type</span> note <span style="color:#000;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	key <span style="color:#458;font-weight:bold">uintptr</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>note 的底层实现机制跟操作系统相关，不同系统使用不同的机制，比如 linux 下使用的 futex 系统调用，而 mac 下则是使用的 pthread_cond_t 条件变量，note 对这些底层机制做了一个抽象和封装。</p>
<p>这种封装给扩展性带来了很大的好处，比如当睡眠和唤醒功能需要支持新平台时，只需要在 note 层增加对特定平台的支持即可，不需要修改上层的任何代码。</p>
</blockquote>
<p>上面这一段来自阿波张的系列教程。我们接着来看下 notesleep 的实现：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// src/runtime/lock_sema.go
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">notesleep</span>(n <span style="color:#000;font-weight:bold">*</span>note) {
</span></span><span style="display:flex;"><span>	gp <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">getg</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> gp <span style="color:#000;font-weight:bold">!=</span> gp.m.g0 {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">throw</span>(<span style="color:#d14">&#34;notesleep not on g0&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#900;font-weight:bold">semacreate</span>(gp.m)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> !atomic.<span style="color:#900;font-weight:bold">Casuintptr</span>(<span style="color:#000;font-weight:bold">&amp;</span>n.key, <span style="color:#099">0</span>, <span style="color:#0086b3">uintptr</span>(unsafe.<span style="color:#900;font-weight:bold">Pointer</span>(gp.m))) {
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">// Must be locked (got wakeup).
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#000;font-weight:bold">if</span> n.key <span style="color:#000;font-weight:bold">!=</span> locked {
</span></span><span style="display:flex;"><span>			<span style="color:#900;font-weight:bold">throw</span>(<span style="color:#d14">&#34;notesleep - waitm out of sync&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// Queued. Sleep.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 入队了，开始休眠
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 表示 m 被阻塞了
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	gp.m.blocked = <span style="color:#000;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 注意这里分了两种
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">*</span>cgo_yield <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">nil</span> { <span style="color:#998;font-style:italic">// 如果 cgo 调用为空，-1 表示无限期休眠
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#900;font-weight:bold">semasleep</span>(<span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>)
</span></span><span style="display:flex;"><span>	} <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">// Sleep for an arbitrary-but-moderate interval to poll libc interceptors.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// 这里之所以需要用一个循环，是因为 futexsleep 有可能意外从睡眠中返回，
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	  <span style="color:#998;font-style:italic">// 所以 futexsleep 函数返回后还需要检查 note.key 是否还是 0，
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	  <span style="color:#998;font-style:italic">// 如果是 0 则表示并不是其它工作线程唤醒了我们，
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	  <span style="color:#998;font-style:italic">// 只是 futexsleep 意外返回了，需要再次调用 futexsleep 进入睡眠
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#000;font-weight:bold">const</span> ns = <span style="color:#099">10e6</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">for</span> atomic.<span style="color:#900;font-weight:bold">Loaduintptr</span>(<span style="color:#000;font-weight:bold">&amp;</span>n.key) <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#900;font-weight:bold">semasleep</span>(ns)
</span></span><span style="display:flex;"><span>			<span style="color:#900;font-weight:bold">asmcgocall</span>(<span style="color:#000;font-weight:bold">*</span>cgo_yield, <span style="color:#000;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 一旦，note.key 不为 0，表示其他工作线程唤醒了我们，
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 将 阻塞 放开
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	gp.m.blocked = <span style="color:#000;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们继续看下<code>noteclear</code>，负责将 note.key 置零。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// src/runtime/proc.go
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// One-time notifications.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">noteclear</span>(n <span style="color:#000;font-weight:bold">*</span>note) {
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> GOOS <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#34;aix&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">// On AIX, semaphores might not synchronize the memory in some
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// rare cases. See issue #30189.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		atomic.<span style="color:#900;font-weight:bold">Storeuintptr</span>(<span style="color:#000;font-weight:bold">&amp;</span>n.key, <span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>	} <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>		n.key = <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>至此，找不到工作的 M 就休眠了。当其他工作线程发现有工作要做时，就会找到空闲的 M，再通过 m.park 字段唤醒本线程。</p>
<p>唤醒之后，回到<code>findRunnable</code>函数，继续寻找 g，找到后返回 schedule 函数，然后去执行找到的 g。</p>
<p>这就是 M 找工作的过程，真不简单呀。</p>
<h2 id="startm">startm</h2>
<p>最后，再看下<code>startm</code>函数，这是启动 M 的过程。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">82
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">83
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">84
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">85
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">86
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">87
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">88
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">89
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">90
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// src/runtime/proc.go
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 调度 M 运行 P，必要时可以创建 M。
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// Schedules some M to run the p (creates an M if necessary).
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// If p==nil, tries to get an idle P, if no idle P&#39;s does nothing.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// May run with m.p==nil, so write barriers are not allowed.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// If spinning is set, the caller has incremented nmspinning and must provide a
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// P. startm will set m.spinning in the newly started M.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 如果 spinning 被设置，说明调用者递增了 自旋M 数，而且必须提供 P，所以这个情况 P 不能为空。
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// Callers passing a non-nil P must call from a non-preemptible context. See
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// comment on acquirem below.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// Must not have write barriers because this may be called without a P.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//go:nowritebarrierrec
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">startm</span>(pp <span style="color:#000;font-weight:bold">*</span>p, spinning <span style="color:#458;font-weight:bold">bool</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 取一个 M
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	mp <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">acquirem</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#900;font-weight:bold">lock</span>(<span style="color:#000;font-weight:bold">&amp;</span>sched.lock)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> pp <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> spinning {
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">// TODO(prattmic): All remaining calls to this function
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#998;font-style:italic">// with _p_ == nil could be cleaned up to find a P
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#998;font-style:italic">// before calling startm.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#900;font-weight:bold">throw</span>(<span style="color:#d14">&#34;startm: P required for spinning=true&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// 从空闲列表中取一个 P
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		pp, _ = <span style="color:#900;font-weight:bold">pidleget</span>(<span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// 如果没取到 P，啥也不做，直接返回。
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#000;font-weight:bold">if</span> pp <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#900;font-weight:bold">unlock</span>(<span style="color:#000;font-weight:bold">&amp;</span>sched.lock)
</span></span><span style="display:flex;"><span>			<span style="color:#900;font-weight:bold">releasem</span>(mp)
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 到这里，已经找到 P 了
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 从全局空闲M列表中取一个 M
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	nmp <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">mget</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> nmp <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">// No M is available, we must drop sched.lock and call newm.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// However, we already own a P to assign to the M.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// Once sched.lock is released, another G (e.g., in a syscall),
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// could find no idle P while checkdead finds a runnable G but
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// no running M&#39;s because this new M hasn&#39;t started yet, thus
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// throwing in an apparent deadlock.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// Avoid this situation by pre-allocating the ID for the new M,
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// thus marking it as &#39;running&#39; before we drop sched.lock. This
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// new M will eventually run the scheduler to execute any
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// queued G&#39;s.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// 翻译过来：如果没有 M 可用，其他 G 也发现这种情况，尝试创建 M，但这个 M 还没有创建出来
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// 为了避免这种情况，通过 ID 来解决
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		id <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">mReserveID</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">unlock</span>(<span style="color:#000;font-weight:bold">&amp;</span>sched.lock)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">var</span> fn <span style="color:#000;font-weight:bold">func</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> spinning {
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">// The caller incremented nmspinning, so set m.spinning in the new M.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			fn = mspinning
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// 用 自旋函数 创建一个 M
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#900;font-weight:bold">newm</span>(fn, pp, id)
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">// Ownership transfer of pp committed by start in newm.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// Preemption is now safe.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#900;font-weight:bold">releasem</span>(mp)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 从全局空闲M列表取到一个M
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#900;font-weight:bold">unlock</span>(<span style="color:#000;font-weight:bold">&amp;</span>sched.lock)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> nmp.spinning {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">throw</span>(<span style="color:#d14">&#34;startm: m is spinning&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> nmp.nextp <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">throw</span>(<span style="color:#d14">&#34;startm: m has p&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> spinning <span style="color:#000;font-weight:bold">&amp;&amp;</span> !<span style="color:#900;font-weight:bold">runqempty</span>(pp) {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">throw</span>(<span style="color:#d14">&#34;startm: p has runnable gs&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// The caller incremented nmspinning, so set m.spinning in the new M.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 设置 M 的自旋状态
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	nmp.spinning = spinning
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 将 P 设为 M 唤醒后优先绑定的P
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	nmp.nextp.<span style="color:#900;font-weight:bold">set</span>(pp)
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 通过 park 唤醒 M
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#900;font-weight:bold">notewakeup</span>(<span style="color:#000;font-weight:bold">&amp;</span>nmp.park)
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// Ownership transfer of pp committed by wakeup. Preemption is now
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// safe.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#900;font-weight:bold">releasem</span>(mp)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>总结一下：</p>
<ol>
<li><code>startm</code>首先检查有没有空闲的 P 可以绑定，如果没有，啥也不做，直接返回；</li>
<li>如果找到空闲的 P，再从空闲 M 列表找，如果没有空闲的 M，就会创建一个，然后返回。</li>
<li>否则，将找到的空闲的 P 设置为 M 的 nextp，并将 M 唤醒。</li>
</ol>
<h2 id="m0-的创建">M0 的创建</h2>
<p>我们再看下 mstart()。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// mstart is the entry-point for new Ms.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// It is written in assembly, uses ABI0, is marked TOPFRAME, and calls mstart0.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">mstart</span>()
</span></span></code></pre></td></tr></table>
</div>
</div><p>这是 M 创建的入口，是用汇编写的，标记为TOPFRAME。</p>
<p>所以，Go 程序启动的时候，会先进到这里。</p>
<p>继续，看下mstart0。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// mstart0 is the Go entry-point for new Ms.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">mstart0</span>() {
</span></span><span style="display:flex;"><span>	gp <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">getg</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	osStack <span style="color:#000;font-weight:bold">:=</span> gp.stack.lo <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> osStack {
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">// Initialize stack bounds from system stack.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// Cgo may have left stack size in stack.hi.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// minit may update the stack bounds.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// Note: these bounds may not be very accurate.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// We set hi to &amp;size, but there are things above
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// it. The 1024 is supposed to compensate this,
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// but is somewhat arbitrary.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		size <span style="color:#000;font-weight:bold">:=</span> gp.stack.hi
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> size <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>			size = <span style="color:#099">8192</span> <span style="color:#000;font-weight:bold">*</span> sys.StackGuardMultiplier
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		gp.stack.hi = <span style="color:#0086b3">uintptr</span>(<span style="color:#900;font-weight:bold">noescape</span>(unsafe.<span style="color:#900;font-weight:bold">Pointer</span>(<span style="color:#000;font-weight:bold">&amp;</span>size)))
</span></span><span style="display:flex;"><span>		gp.stack.lo = gp.stack.hi <span style="color:#000;font-weight:bold">-</span> size <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1024</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// Initialize stack guard so that we can start calling regular
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// Go code.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	gp.stackguard0 = gp.stack.lo <span style="color:#000;font-weight:bold">+</span> _StackGuard
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// This is the g0, so we can also call go:systemstack
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// functions, which check stackguard1.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	gp.stackguard1 = gp.stackguard0
</span></span><span style="display:flex;"><span>	<span style="color:#900;font-weight:bold">mstart1</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// Exit this thread.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> <span style="color:#900;font-weight:bold">mStackIsSystemAllocated</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">// Windows, Solaris, illumos, Darwin, AIX and Plan 9 always system-allocate
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// the stack, but put it in gp.stack before mstart,
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// so the logic above hasn&#39;t set osStack yet.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		osStack = <span style="color:#000;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#900;font-weight:bold">mexit</span>(osStack)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// The go:noinline is to guarantee the getcallerpc/getcallersp below are safe,
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// so that we can set up g0.sched to return to the call of mstart1 above.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//go:noinline
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">mstart1</span>() {
</span></span><span style="display:flex;"><span>	gp <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">getg</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> gp <span style="color:#000;font-weight:bold">!=</span> gp.m.g0 {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">throw</span>(<span style="color:#d14">&#34;bad runtime·mstart&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// Set up m.g0.sched as a label returning to just
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// after the mstart1 call in mstart0 above, for use by goexit0 and mcall.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// We&#39;re never coming back to mstart1 after we call schedule,
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// so other calls can reuse the current frame.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// And goexit0 does a gogo that needs to return from mstart1
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// and let mstart0 exit the thread.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	gp.sched.g = <span style="color:#900;font-weight:bold">guintptr</span>(unsafe.<span style="color:#900;font-weight:bold">Pointer</span>(gp))
</span></span><span style="display:flex;"><span>	gp.sched.pc = <span style="color:#900;font-weight:bold">getcallerpc</span>()
</span></span><span style="display:flex;"><span>	gp.sched.sp = <span style="color:#900;font-weight:bold">getcallersp</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#900;font-weight:bold">asminit</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#900;font-weight:bold">minit</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// Install signal handlers; after minit so that minit can
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// prepare the thread to be able to handle the signals.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 启动 M0
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> gp.m <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">&amp;</span>m0 {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">mstartm0</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> fn <span style="color:#000;font-weight:bold">:=</span> gp.m.mstartfn; fn <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">fn</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> gp.m <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">&amp;</span>m0 {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">acquirep</span>(gp.m.nextp.<span style="color:#900;font-weight:bold">ptr</span>())
</span></span><span style="display:flex;"><span>		gp.m.nextp = <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 开始调度
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#900;font-weight:bold">schedule</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="m0-的作用">M0 的作用</h2>
<p>如前所述，M0 是go runtime 创建的第一个系统线程（即主线程），一个 Go 进程只有一个 M0。</p>
<p>从「<strong>数据结构</strong>」看，M0 跟其他 M 没有区别，都是m结构。</p>
<p>从「<strong>创建</strong>」看，M0 是一个全局变量，在 <code>src/runtime/proc.go</code> 定义，M0 不需要在堆上分配内存，其他 M 都是通过 <code>new(m)</code> 创建出来的对象，其内存是从堆上进行分配的。</p>
<p>另外，从<code>mstart</code>代码看，M0 是进程在启动时由汇编创建的，而其他 M 都是go runtime创建的。</p>
<p>从「<strong>作用</strong>」看，M0 负责执行初始化操作和启动第一个 G，Golang 程序启动时会首先启动 M0，M0 和主线程进行了绑定，当 M0 启动第一个 G 即 main goroutine 后功能就和其他的 M 一样了 。</p>
<h2 id="其他函数分析">其他函数分析</h2>
<p>关于 M，还有几个函数没有分析，我们也依次看下。</p>
<p>第一个函数是<code>runqput</code>，该函数将可运行的 G 放到 P 的本地队列。</p>
<h3 id="runqput">runqput</h3>
<p>该函数的第一个参数pp，表示当前绑定的P，第二个参数g，表示可运行的G，第三个参数next，true表示将 g 放入<code>p.runnext</code>，否则放入<code>p.runq</code>队列。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// src/runtime/proc.go#L5957
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// runqput tries to put g on the local runnable queue.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// If next is false, runqput adds g to the tail of the runnable queue.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// If next is true, runqput puts g in the pp.runnext slot.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// If the run queue is full, runnext puts g on the global queue.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// Executed only by the owner P.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">runqput</span>(pp <span style="color:#000;font-weight:bold">*</span>p, gp <span style="color:#000;font-weight:bold">*</span>g, next <span style="color:#458;font-weight:bold">bool</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> randomizeScheduler <span style="color:#000;font-weight:bold">&amp;&amp;</span> next <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#900;font-weight:bold">fastrandn</span>(<span style="color:#099">2</span>) <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>		next = <span style="color:#000;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> next {
</span></span><span style="display:flex;"><span>	retryNext:
</span></span><span style="display:flex;"><span>		oldnext <span style="color:#000;font-weight:bold">:=</span> pp.runnext
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// 如果没有放入成功，继续尝试
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#000;font-weight:bold">if</span> !pp.runnext.<span style="color:#900;font-weight:bold">cas</span>(oldnext, <span style="color:#900;font-weight:bold">guintptr</span>(unsafe.<span style="color:#900;font-weight:bold">Pointer</span>(gp))) {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">goto</span> retryNext
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// 放入成功，且之前为0，表示当前绑定的 P，已经将runnext设置完成，直接返回
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#000;font-weight:bold">if</span> oldnext <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">// Kick the old runnext out to the regular run queue.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// 否则，将其原来的 runnetx 放到普通的LRQ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		gp = oldnext.<span style="color:#900;font-weight:bold">ptr</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>retry:
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 取 LRQ 队头
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	h <span style="color:#000;font-weight:bold">:=</span> atomic.<span style="color:#900;font-weight:bold">LoadAcq</span>(<span style="color:#000;font-weight:bold">&amp;</span>pp.runqhead) <span style="color:#998;font-style:italic">// load-acquire, synchronize with consumers
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 取 LRQ 队尾
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	t <span style="color:#000;font-weight:bold">:=</span> pp.runqtail
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 如果 LRQ 队列未满，直接放入队尾，且队尾向后移动一个
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> t<span style="color:#000;font-weight:bold">-</span>h &lt; <span style="color:#0086b3">uint32</span>(<span style="color:#0086b3">len</span>(pp.runq)) {
</span></span><span style="display:flex;"><span>		pp.runq[t<span style="color:#000;font-weight:bold">%</span><span style="color:#0086b3">uint32</span>(<span style="color:#0086b3">len</span>(pp.runq))].<span style="color:#900;font-weight:bold">set</span>(gp)
</span></span><span style="display:flex;"><span>		atomic.<span style="color:#900;font-weight:bold">StoreRel</span>(<span style="color:#000;font-weight:bold">&amp;</span>pp.runqtail, t<span style="color:#000;font-weight:bold">+</span><span style="color:#099">1</span>) <span style="color:#998;font-style:italic">// store-release, makes the item available for consumption
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span> 	<span style="color:#998;font-style:italic">// LRQ 队列满了，runqputslow 负责将LRQ中 1/2 的 g 放入GRQ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> <span style="color:#900;font-weight:bold">runqputslow</span>(pp, gp, h, t) {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// the queue is not full, now the put above must succeed
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// LRQ 未满，继续尝试存放
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">goto</span> retry
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>总结一下：</p>
<ol>
<li><code>runnext</code>具备高优先级，通过next开关控制放入<code>runnext</code>还是<code>runq</code></li>
<li>由 p 中的runq, runqhead, runqtail组成的无锁循环队列，存放可运行的g</li>
<li>如果存放过程中 LRQ 队列满了，则将部分 g 放入 GRQ</li>
<li><code>runqput</code>将新加入的 g 放到了队尾</li>
</ol>
<p>接着，继续看下<code>runqputslow</code>函数。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// src/runtime/proc.go#L5995
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// Put g and a batch of work from local runnable queue on global queue.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// Executed only by the owner P.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">runqputslow</span>(pp <span style="color:#000;font-weight:bold">*</span>p, gp <span style="color:#000;font-weight:bold">*</span>g, h, t <span style="color:#458;font-weight:bold">uint32</span>) <span style="color:#458;font-weight:bold">bool</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">var</span> batch [<span style="color:#0086b3">len</span>(pp.runq)<span style="color:#000;font-weight:bold">/</span><span style="color:#099">2</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1</span>]<span style="color:#000;font-weight:bold">*</span>g
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// First, grab a batch from local queue.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 取 LRQ 队列中一半的g
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	n <span style="color:#000;font-weight:bold">:=</span> t <span style="color:#000;font-weight:bold">-</span> h
</span></span><span style="display:flex;"><span>	n = n <span style="color:#000;font-weight:bold">/</span> <span style="color:#099">2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> n <span style="color:#000;font-weight:bold">!=</span> <span style="color:#0086b3">uint32</span>(<span style="color:#0086b3">len</span>(pp.runq)<span style="color:#000;font-weight:bold">/</span><span style="color:#099">2</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">throw</span>(<span style="color:#d14">&#34;runqputslow: queue is not full&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 将一半的 g 放入临时 batch 数组
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">for</span> i <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">uint32</span>(<span style="color:#099">0</span>); i &lt; n; i<span style="color:#000;font-weight:bold">++</span> {
</span></span><span style="display:flex;"><span>		batch[i] = pp.runq[(h<span style="color:#000;font-weight:bold">+</span>i)<span style="color:#000;font-weight:bold">%</span><span style="color:#0086b3">uint32</span>(<span style="color:#0086b3">len</span>(pp.runq))].<span style="color:#900;font-weight:bold">ptr</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> !atomic.<span style="color:#900;font-weight:bold">CasRel</span>(<span style="color:#000;font-weight:bold">&amp;</span>pp.runqhead, h, h<span style="color:#000;font-weight:bold">+</span>n) { <span style="color:#998;font-style:italic">// cas-release, commits consume
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	batch[n] = gp
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 如果随机调度开关打开，将 batch 数组随机一下
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> randomizeScheduler {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">for</span> i <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">uint32</span>(<span style="color:#099">1</span>); i <span style="color:#000;font-weight:bold">&lt;=</span> n; i<span style="color:#000;font-weight:bold">++</span> {
</span></span><span style="display:flex;"><span>			j <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">fastrandn</span>(i <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1</span>)
</span></span><span style="display:flex;"><span>			batch[i], batch[j] = batch[j], batch[i]
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// Link the goroutines.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 将 g  链接起来
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">for</span> i <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">uint32</span>(<span style="color:#099">0</span>); i &lt; n; i<span style="color:#000;font-weight:bold">++</span> {
</span></span><span style="display:flex;"><span>		batch[i].schedlink.<span style="color:#900;font-weight:bold">set</span>(batch[i<span style="color:#000;font-weight:bold">+</span><span style="color:#099">1</span>])
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 放入临时 gQueue 队列
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">var</span> q gQueue
</span></span><span style="display:flex;"><span>	q.head.<span style="color:#900;font-weight:bold">set</span>(batch[<span style="color:#099">0</span>])
</span></span><span style="display:flex;"><span>	q.tail.<span style="color:#900;font-weight:bold">set</span>(batch[n])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// Now put the batch on global queue.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 放入 临时队列 放入 GRQ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#900;font-weight:bold">lock</span>(<span style="color:#000;font-weight:bold">&amp;</span>sched.lock)
</span></span><span style="display:flex;"><span>	<span style="color:#900;font-weight:bold">globrunqputbatch</span>(<span style="color:#000;font-weight:bold">&amp;</span>q, <span style="color:#0086b3">int32</span>(n<span style="color:#000;font-weight:bold">+</span><span style="color:#099">1</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#900;font-weight:bold">unlock</span>(<span style="color:#000;font-weight:bold">&amp;</span>sched.lock)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>总结一下，<code>runqputslow</code>就是将 LRQ 队列中靠近头的一半 g 放入 GRQ，如果随机调度打开，将 g 的顺序随机打乱一次。</p>
<h2 id="内容回顾">内容回顾</h2>
<h2 id="参考资料">参考资料</h2>
<ol>
<li><a href="https://golang.design/under-the-hood/zh-cn/part2runtime/ch06sched/mpg/">https://golang.design/under-the-hood/zh-cn/part2runtime/ch06sched/mpg/</a></li>
<li><a href="https://studygolang.com/articles/28706">https://studygolang.com/articles/28706</a></li>
<li><a href="https://golang.design/go-questions/sched/m-worker/">https://golang.design/go-questions/sched/m-worker/</a></li>
<li><a href="https://blog.tianfeiyu.com/2021/12/12/golang_gpm/">https://blog.tianfeiyu.com/2021/12/12/golang_gpm/</a></li>
<li><a href="https://mp.weixin.qq.com/s/2objs5JrlnKnwFbF4a2z2g">https://mp.weixin.qq.com/s/2objs5JrlnKnwFbF4a2z2g</a></li>
</ol>

        </div>

        
<div class="post-archive">
    <ul class="post-copyright">
        <li><strong>原文作者：</strong><a rel="author" href="http://www.subond.com/">Kevin</a></li>
        <li style="word-break:break-all"><strong>原文链接：</strong><a href="http://www.subond.com/post/2023-08-07_gmp_m/">http://www.subond.com/post/2023-08-07_gmp_m/</a></li>
        <li><strong>版权声明：</strong>本作品采用<a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li>
    </ul>
</div>
<br/>



        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/post/2023-07-25_gmp_g/">深入理解Go调度器：G 的创建（二）</a></li>
        
        <li><a href="/post/2023-07-24_gpm_gpm0/">深入理解Go调度器：初识GMP模型（一）</a></li>
        
        <li><a href="/post/2023-08-03_selfindulgent/">[译文]时间和财富是如何流失的</a></li>
        
        <li><a href="/post/2023-07-31_kids/">[译文]养育孩子</a></li>
        
        <li><a href="/post/2023-07-28_wisdom/">[译文]智慧，是否值得？</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/go%E8%B0%83%E5%BA%A6%E5%99%A8' target="_blank">GO调度器</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    
    

</div>

                    <footer id="footer">
    <div>
        &copy; 2024 <a href="http://www.subond.com/">凯文的个人博客 By Kevin</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://www.flysnow.org/" target="_black"><span class="badge-subject">Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>
<style type="text/css">
div.highlight {
    position: relative;
    margin: 1em 0px;
}

.copy-code {
    display: none;
    position: absolute;
    top: 4px;
    right: 4px;
    color: rgba(255, 255, 255, 0.8);
    background: rgba(78, 78, 78, 0.8);
    border-radius: var(--radius);
    padding: 0 5px;
    font: inherit;
    user-select: none;
    cursor: pointer;
    border: 0;
    --radius: 8px;
}

div.highlight:hover .copy-code,pre:hover .copy-code {
    display: block;
}

</style>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>


    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='http://www.subond.com/search' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="http://www.subond.com/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="http://www.subond.com/post/2024-02-01_ali_nextgateway/" title="阿里基于DPU的下一代边缘云网关实践" target="_blank">阿里基于DPU的下一代边缘云网关实践</a>
    </li>
    
    <li>
        <a href="http://www.subond.com/post/2023-09-19_zh_writing_is_magic/" title="[译]长文写作的魔力" target="_blank">[译]长文写作的魔力</a>
    </li>
    
    <li>
        <a href="http://www.subond.com/post/2023-09-08_shell_concurrency/" title="如何在 Shell 中实现并发执行" target="_blank">如何在 Shell 中实现并发执行</a>
    </li>
    
    <li>
        <a href="http://www.subond.com/post/2023-08-30_gmp_scheduler_init2/" title="深入理解Go调度器：main goroutine的创建（六）" target="_blank">深入理解Go调度器：main goroutine的创建（六）</a>
    </li>
    
    <li>
        <a href="http://www.subond.com/post/2023-08-23_gmp_scheduler_init/" title="深入理解Go调度器：调度器的初始化（五）" target="_blank">深入理解Go调度器：调度器的初始化（五）</a>
    </li>
    
    <li>
        <a href="http://www.subond.com/post/2023-08-15_go_stack/" title="[转载]Go 语言机制之栈与指针" target="_blank">[转载]Go 语言机制之栈与指针</a>
    </li>
    
    <li>
        <a href="http://www.subond.com/post/2023-08-12_gmp_p/" title="深入理解Go调度器：如何初始化P（四）" target="_blank">深入理解Go调度器：如何初始化P（四）</a>
    </li>
    
    <li>
        <a href="http://www.subond.com/post/2023-08-07_gmp_m/" title="深入理解Go调度器：M 如何找工作（三）" target="_blank">深入理解Go调度器：M 如何找工作（三）</a>
    </li>
    
    <li>
        <a href="http://www.subond.com/post/2023-08-03_selfindulgent/" title="[译文]时间和财富是如何流失的" target="_blank">[译文]时间和财富是如何流失的</a>
    </li>
    
    <li>
        <a href="http://www.subond.com/post/2023-07-31_kids/" title="[译文]养育孩子" target="_blank">[译文]养育孩子</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="http://www.subond.com/categories/go%E7%AC%94%E8%AE%B0/">Go笔记 (8)</a></li>
    
    <li><a href="http://www.subond.com/categories/go%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/">Go高性能编程 (7)</a></li>
    
    <li><a href="http://www.subond.com/categories/%E6%8A%80%E6%9C%AF/">技术 (32)</a></li>
    
    <li><a href="http://www.subond.com/categories/%E6%95%A3%E6%96%87/">散文 (10)</a></li>
    
    <li><a href="http://www.subond.com/categories/%E8%AF%91%E6%96%87%E9%9B%86/">译文集 (4)</a></li>
    
    <li><a href="http://www.subond.com/categories/%E9%B8%BF%E9%9B%81%E4%BC%A0%E4%B9%A6/">鸿雁传书 (14)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="http://www.subond.com/tags/algorithm/">algorithm</a>
    
    <a href="http://www.subond.com/tags/alignment/">alignment</a>
    
    <a href="http://www.subond.com/tags/carrer/">carrer</a>
    
    <a href="http://www.subond.com/tags/cloud/">cloud</a>
    
    <a href="http://www.subond.com/tags/defer/">defer</a>
    
    <a href="http://www.subond.com/tags/distributed-systems/">distributed systems</a>
    
    <a href="http://www.subond.com/tags/docker/">docker</a>
    
    <a href="http://www.subond.com/tags/dpu/">DPU</a>
    
    <a href="http://www.subond.com/tags/essay/">essay</a>
    
    <a href="http://www.subond.com/tags/git/">git</a>
    
    <a href="http://www.subond.com/tags/gitbook/">gitbook</a>
    
    <a href="http://www.subond.com/tags/go/">go</a>
    
    <a href="http://www.subond.com/tags/golang/">golang</a>
    
    <a href="http://www.subond.com/tags/go%E8%B0%83%E5%BA%A6%E5%99%A8/">GO调度器</a>
    
    <a href="http://www.subond.com/tags/growth/">growth</a>
    
    <a href="http://www.subond.com/tags/life/">life</a>
    
    <a href="http://www.subond.com/tags/linux/">linux</a>
    
    <a href="http://www.subond.com/tags/mutex/">mutex</a>
    
    <a href="http://www.subond.com/tags/process/">process</a>
    
    <a href="http://www.subond.com/tags/pthread/">pthread</a>
    
    <a href="http://www.subond.com/tags/reading/">reading</a>
    
    <a href="http://www.subond.com/tags/shell/">Shell</a>
    
    <a href="http://www.subond.com/tags/slice/">slice</a>
    
    <a href="http://www.subond.com/tags/smartswitch/">SmartSwitch</a>
    
    <a href="http://www.subond.com/tags/string/">string</a>
    
    <a href="http://www.subond.com/tags/struct/">struct</a>
    
    <a href="http://www.subond.com/tags/vagrant/">vagrant</a>
    
    <a href="http://www.subond.com/tags/work/">work</a>
    
    <a href="http://www.subond.com/tags/writing/">writing</a>
    
    <a href="http://www.subond.com/tags/%E4%BA%91%E7%BD%91%E7%BB%9C/">云网络</a>
    
    <a href="http://www.subond.com/tags/%E4%BA%BA%E7%94%9F%E4%BF%A1%E5%BF%B5/">人生信念</a>
    
    <a href="http://www.subond.com/tags/%E5%86%85%E5%9C%A8%E8%AE%B0%E5%88%86%E7%89%8C/">内在记分牌</a>
    
    <a href="http://www.subond.com/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/">内存管理</a>
    
    <a href="http://www.subond.com/tags/%E5%86%99%E4%BD%9C/">写作</a>
    
    <a href="http://www.subond.com/tags/%E5%A4%9A%E8%BF%9B%E7%A8%8B/">多进程</a>
    
    <a href="http://www.subond.com/tags/%E5%AD%A6%E4%B9%A0/">学习</a>
    
    <a href="http://www.subond.com/tags/%E5%B9%B6%E5%8F%91/">并发</a>
    
    <a href="http://www.subond.com/tags/%E5%BF%83%E7%90%86%E5%AD%A6/">心理学</a>
    
    <a href="http://www.subond.com/tags/%E6%80%9D%E8%80%83/">思考</a>
    
    <a href="http://www.subond.com/tags/%E6%83%85%E6%84%9F/">情感</a>
    
    <a href="http://www.subond.com/tags/%E6%95%99%E8%82%B2/">教育</a>
    
    <a href="http://www.subond.com/tags/%E6%97%B6%E9%97%B4/">时间</a>
    
    <a href="http://www.subond.com/tags/%E6%99%BA%E6%85%A7/">智慧</a>
    
    <a href="http://www.subond.com/tags/%E6%A0%BC%E9%9B%B7%E5%8E%84%E5%A7%86/">格雷厄姆</a>
    
    <a href="http://www.subond.com/tags/%E7%90%86%E8%B4%A2/">理财</a>
    
    <a href="http://www.subond.com/tags/%E7%94%9F%E6%B4%BB/">生活</a>
    
    <a href="http://www.subond.com/tags/%E7%BB%8F%E6%B5%8E/">经济</a>
    
    <a href="http://www.subond.com/tags/%E7%BD%91%E7%BB%9C%E5%8D%B8%E8%BD%BD/">网络卸载</a>
    
    <a href="http://www.subond.com/tags/%E8%B4%A2%E5%AF%8C/">财富</a>
    
    <a href="http://www.subond.com/tags/%E9%87%91%E9%92%B1%E5%BF%83%E7%90%86%E5%AD%A6/">金钱心理学</a>
    
    <a href="http://www.subond.com/tags/%E9%98%85%E8%AF%BB/">阅读</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="http://github.com/yusubond" title="github">Github</a>
        </li>
        
        <li>
            <a target="_blank" href="https://weibo.cn/u/2746421033" title="微博">微博</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="http://www.subond.com/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>