<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    

    <title>深入理解Go调度器：如何初始化P（四） | 凯文的个人博客</title>
    <meta property="og:title" content="深入理解Go调度器：如何初始化P（四） - 凯文的个人博客">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2023-08-12T00:00:00&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2023-08-28T20:09:25&#43;08:00'>
        
    <meta name="Keywords" content="golang,博客">
    <meta name="description" content="深入理解Go调度器：如何初始化P（四）">
        
    <meta name="author" content="Kevin">
    <meta property="og:url" content="http://www.subond.com/post/2023-08-12_gmp_p/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
    
    
    
</head>

<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="http://www.subond.com/">
                        凯文的个人博客
                    </a>
                
                <p class="description">专注于云计算网络，个人成长</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="http://www.subond.com/">首页</a>
                    
                    <a  href="http://www.subond.com/archives/" title="归档">归档</a>
                    
                    <a  href="http://www.subond.com/reading/" title="阅读">阅读</a>
                    
                    <a  href="http://www.subond.com/about/" title="关于我">关于我</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">深入理解Go调度器：如何初始化P（四）</h1>
        </header>
        <date class="post-meta meta-date">
            2023年8月12日
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category">
                <a href='/categories/go%E7%AC%94%E8%AE%B0' target="_blank">Go笔记</a>
            </span>
            
            <span class="meta-category">
                <a href='/categories/%E6%8A%80%E6%9C%AF' target="_blank">技术</a>
            </span>
            
        </div>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span>
                    阅读</span></span>
        </div>
        
        
        <div class="post-content">
            <p>大家好， 我们继续 Go 调度器的旅程。</p>
<p>这篇文章，我们讲讲 GPM 模型中 P 组件内容，主要包含以下方面：</p>
<ul>
<li>为什么需要 P</li>
<li>P 的结构</li>
<li>P 的数量</li>
<li>P 的销毁</li>
<li>最重要的 procresize 函数</li>
</ul>
<h2 id="为什么需要-p">为什么需要 P</h2>
<p>在<a href="https://www.subond.com/post/2023-07-24_golang_gpm/">初始GMP调度器</a>中已经有所提及，我们在回顾一下。</p>
<p>在 Golang 1.1 版本之前调度器中还没有 P 组件，此时调度器的性能还比较差，社区的 Dmitry Vyukov 大佬针对当前调度器中存在的问题进行了总结并设计引入 P 组件来解决当前面临的问题（<a href="https://docs.google.com/document/d/1TTj4T2JO42uD5ID9e89oa0sLKhJYD0Y_kqxDv3I3XMw/edit#heading=h.mmq8lm48qfcw"><strong>Scalable Go Scheduler Design Doc</strong></a>），并在 Go 1.1 版本中引入了 P 组件，引入 P 组件后不仅解决了文档中列的几个问题，也引入了一些很好的机制。</p>
<p>文档中列出了调度器主要的 4 个问题，分别有：</p>
<ol>
<li>
<p>单一的全局互斥锁。</p>
<p>在以前没有 P 组件的时候，只有 G 和 M 两个组件，以及一个全局 G 队列。当工作线程 M 需要执行 G 的时候，需要频繁地加互斥锁从全局队列中获取 G 来执行，加锁处理对其他 G 的处理（比如创建，完成，调度等）存在很大的时延，性能很差。</p>
</li>
<li>
<p>G 的切换。</p>
<p>M 频繁地切换可运行的 G 会增加延迟和开销。比如新建的 G 会被放入全局队列，而不是在 M 的本地执行，这会导致不必要的开销和延迟，应该优先在创建 G 的 M 上执行。</p>
<p>引入 P 组件之后，新建的 G 会优先放在关联 P 的本地队列中。</p>
</li>
<li>
<p>M 的内存问题。</p>
<p>在以前的版本中，M 结构体中有一个<code>mcache</code>字段，这是一个内存分配池。小对象会直接从<code>mcache</code>中进行分配，因为 G  在 M 上一个一个顺序执行的，G 申请小对象时会直接从<code>mcache</code>中进行分配，G 可以无锁地访问。但是，runtime 中每个时间都只会有一部分的 M 在运行 G，那些处于系统调用的 M 其实是不需要<code>mcache</code>的，这就造成了不必要的浪费。</p>
<p>每个 M 的<code>mcache</code> 大概有 2M 大小的可用内存，当有上千个 G 处于阻塞状态时，就会有大量的内存浪费。</p>
<p>其次，也存在较差的数据局部性问题。这是说 M 运行 G 时对 G 所使用的小对象进行了缓存，当 G 解除阻塞再次调度到同一个 M 时 可以加速访问这些数据，但实际场景中 G 被调度到同一个 M 的概率不高，所以数据局部性不好。</p>
</li>
<li>
<p>频繁的线程阻塞/唤醒问题。</p>
<p>在以前的调度器中，<code>runtime.GOMAXPROCS</code>是限制系统线程的，只有这么多个 M。默认情况下下只有一个系统线程。因为 M 会执行系统调用等操作进入阻塞状态，当 M 阻塞以后不会新建 M 来执行其他任务，而是等待 M 的唤醒，M 在阻塞和唤醒之间频繁切换导致了额外的开销。</p>
<p>引入 P 组件以后，当 M 处于系统调用状态以后，会解除与 P 的关联，调度器会唤醒已有的 M 或者 创建新的 M 来和 P 关联，继续运行 G。</p>
</li>
</ol>
<h2 id="p-的结构">P 的结构</h2>
<p>P 对象的数据结构如下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// src/runtime/runtime2.go#L609
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">type</span> p <span style="color:#000;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	id          <span style="color:#458;font-weight:bold">int32</span>
</span></span><span style="display:flex;"><span>	status      <span style="color:#458;font-weight:bold">uint32</span> <span style="color:#998;font-style:italic">// P 的状态
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	link        puintptr
</span></span><span style="display:flex;"><span>	schedtick   <span style="color:#458;font-weight:bold">uint32</span>     <span style="color:#998;font-style:italic">// 被调度的次数，每调度一次递增
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	syscalltick <span style="color:#458;font-weight:bold">uint32</span>     <span style="color:#998;font-style:italic">// 执行系统调用的次数，每执行一次递增
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	sysmontick  sysmontick <span style="color:#998;font-style:italic">// sysmon 最近一次运行的时间
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	m           muintptr   <span style="color:#998;font-style:italic">// P 所关联的 M，如果 P 为空闲状态，则为 nil
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	mcache      <span style="color:#000;font-weight:bold">*</span>mcache    <span style="color:#998;font-style:italic">// 小对象缓存，可以无锁访问
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	pcache      pageCache  <span style="color:#998;font-style:italic">// 页缓存，也可以无锁访问
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	raceprocctx <span style="color:#458;font-weight:bold">uintptr</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	deferpool    []<span style="color:#000;font-weight:bold">*</span>_defer <span style="color:#998;font-style:italic">// pool of available defer structs (see panic.go)
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	deferpoolbuf [<span style="color:#099">32</span>]<span style="color:#000;font-weight:bold">*</span>_defer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// Cache of goroutine ids, amortizes accesses to runtime·sched.goidgen.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// goroutine ids 缓存
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	goidcache    <span style="color:#458;font-weight:bold">uint64</span>
</span></span><span style="display:flex;"><span>	goidcacheend <span style="color:#458;font-weight:bold">uint64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// Queue of runnable goroutines. Accessed without lock.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// P 的本地可运行队列，LRQ，可无锁方位
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 由 runqhead, runqtail, runq 三者组成的无锁循环队列
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 最多存放 256 个可运行的g
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	runqhead <span style="color:#458;font-weight:bold">uint32</span>
</span></span><span style="display:flex;"><span>	runqtail <span style="color:#458;font-weight:bold">uint32</span>
</span></span><span style="display:flex;"><span>	runq     [<span style="color:#099">256</span>]guintptr
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// runnext, if non-nil, is a runnable G that was ready&#39;d by
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// the current G and should be run next instead of what&#39;s in
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// runq if there&#39;s time remaining in the running G&#39;s time
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// slice. It will inherit the time left in the current time
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// slice. If a set of goroutines is locked in a
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// communicate-and-wait pattern, this schedules that set as a
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// unit and eliminates the (potentially large) scheduling
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// latency that otherwise arises from adding the ready&#39;d
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// goroutines to the end of the run queue.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// Note that while other P&#39;s may atomically CAS this to zero,
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// only the owner P can CAS it to a valid G.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 待运行的 g
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 如果不为空，且当前时间片还有时间的话，优先运行runnext
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 其他 P 可以将其设置为 0，但只有自身的P 可以将其设置为非零
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	runnext guintptr
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// Available G&#39;s (status == Gdead)
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 已结束运行的 G
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	gFree <span style="color:#000;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>		gList
</span></span><span style="display:flex;"><span>		n <span style="color:#458;font-weight:bold">int32</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	sudogcache []<span style="color:#000;font-weight:bold">*</span>sudog
</span></span><span style="display:flex;"><span>	sudogbuf   [<span style="color:#099">128</span>]<span style="color:#000;font-weight:bold">*</span>sudog
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// Cache of mspan objects from the heap.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 来自堆上的 mspan 缓存
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	mspancache <span style="color:#000;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">// We need an explicit length here because this field is used
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// in allocation codepaths where write barriers are not allowed,
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// and eliminating the write barrier/keeping it eliminated from
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// slice updates is tricky, moreso than just managing the length
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// ourselves.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		len <span style="color:#458;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>		buf [<span style="color:#099">128</span>]<span style="color:#000;font-weight:bold">*</span>mspan
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// gc 相关字段
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	gcMarkWorkerMode gcMarkWorkerMode
</span></span><span style="display:flex;"><span>	gcMarkWorkerStartTime <span style="color:#458;font-weight:bold">int64</span>
</span></span><span style="display:flex;"><span>	gcw gcWork
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">......</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// preempt is set to indicate that this P should be enter the
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// scheduler ASAP (regardless of what G is running on it).
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 抢占标记
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	preempt <span style="color:#458;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>有了基本的认识，我们对 P 结构体中的几个关键字段，详细说明下：</p>
<p><code>runnext</code>指向的是 g 指针，表示当前 P （进入<code>_Prunning</code>）立即要运行的 g，可能为<code>nil</code>。</p>
<p>如果此字段不为<code>nil</code>的话，将直接从<code>runnext</code>字段取，而不比从 <code>runq</code> 中取，所以其优先级高于<code>runq</code>。</p>
<p>这个字段是用来实现调度器的亲和性。我们知道一个 g 阻塞时，m 会从 p 的本地队列 或者 全局队列 再获取一个 g 来执行。如果原来的 g 执行阻塞结束，想再次被接着执行，就需要重新在 p 的 <code>runq</code> 进行排队，当<code>runq</code> 中有太多的 g 要执行时，导致这个刚刚被解除阻塞的 g 迟迟无法得到执行，同时还有可能被其他 m 窃取（因为窃取是从尾部开始偷）。从 Go 1.5 开始，得益于 P 的特殊属性，从阻塞 channel 返回的 g 会优先执行，此时只需要将这个 g 放在 <code>runnext</code>上即可。</p>
<p><strong>本地可运行队列LRQ</strong></p>
<ul>
<li><code>runqhead</code>，可运行队列的队头</li>
<li><code>runqtail</code>，可运行队列的队尾</li>
<li><code>runq</code>，可运行队列，最大256</li>
</ul>
<p>这三个字段组成了一个无锁的循环队列，即 P 的本地可运行队列。</p>
<p>M 每次查找工作时，就是从这里找可运行的 g。</p>
<h2 id="p-的数量">P 的数量</h2>
<p>在【初始GPM模型】中已经提到过，P 的数量由用户决定，程序启动时环境变量<code>$GOMAXPROCS</code>或者 runtime 的<code>GOMAXPROCS()</code>方法决定。这意味着在程序的整个生命周期都最多只有<code>$GOMAXPROCS</code>个 G 在同时运行。</p>
<h2 id="p-的销毁">P 的销毁</h2>
<p>如果在整个 Go 程序的运行时没有调整<code>GOMAXPROCS</code>，P 的数量就是不变的，所以不存在销毁。但是未使用的 P 会放到调度器的<code>sched.pidle</code>队列中，等有需要的时候，再从里面取出。</p>
<p>如果调小了<code>GOMAXPROCS</code>，那么会通过<code>p.destroy()</code>函数将多余的 P 关联的资源回收，并且将 P 设置为<code>_Pdead</code>状态，此时可能还有与 P 关联的 M，所以 P 对象不会回收。</p>
<p><strong>扩展</strong></p>
<p>有一篇博客提到了如何缩小它。</p>
<h2 id="p-的状态">P 的状态</h2>
<p>P 总共有五种状态，各自定义如下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// src/runtime/runtime2.go#L106
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">const</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// P status
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// _Pidle means a P is not being used to run user code or the
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// scheduler. Typically, it&#39;s on the idle P list and available
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// to the scheduler, but it may just be transitioning between
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// other states.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// The P is owned by the idle list or by whatever is
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// transitioning its state. Its run queue is empty.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	_Pidle = <span style="color:#000;font-weight:bold">iota</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// _Prunning means a P is owned by an M and is being used to
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// run user code or the scheduler. Only the M that owns this P
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// is allowed to change the P&#39;s status from _Prunning. The M
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// may transition the P to _Pidle (if it has no more work to
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// do), _Psyscall (when entering a syscall), or _Pgcstop (to
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// halt for the GC). The M may also hand ownership of the P
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// off directly to another M (e.g., to schedule a locked G).
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	_Prunning
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// _Psyscall means a P is not running user code. It has
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// affinity to an M in a syscall but is not owned by it and
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// may be stolen by another M. This is similar to _Pidle but
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// uses lightweight transitions and maintains M affinity.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// Leaving _Psyscall must be done with a CAS, either to steal
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// or retake the P. Note that there&#39;s an ABA hazard: even if
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// an M successfully CASes its original P back to _Prunning
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// after a syscall, it must understand the P may have been
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// used by another M in the interim.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	_Psyscall
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// _Pgcstop means a P is halted for STW and owned by the M
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// that stopped the world. The M that stopped the world
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// continues to use its P, even in _Pgcstop. Transitioning
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// from _Prunning to _Pgcstop causes an M to release its P and
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// park.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// The P retains its run queue and startTheWorld will restart
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// the scheduler on Ps with non-empty run queues.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	_Pgcstop
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// _Pdead means a P is no longer used (GOMAXPROCS shrank). We
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// reuse Ps if GOMAXPROCS increases. A dead P is mostly
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// stripped of its resources, though a few things remain
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// (e.g., trace buffers).
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	_Pdead
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>翻译一下：</p>
<table>
<thead>
<tr>
<th>状态</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>_Pidel</code></td>
<td>没有运行任何代码，或者被调度器调度到，此时 P 的 LRQ 为空</td>
</tr>
<tr>
<td><code>_Prunning</code></td>
<td>P 被 M 绑定，且运行用户代码或者调度器代码。只有绑定的 M 才可以改变<code>_Prunning</code>状态。<!-- raw HTML omitted -->M 可以修改 P 的状态为<code>_Pidle</code>(无工作可做)、<code>_Psyscall</code>(系统调用)、<code>_Pgcstop</code>(GC)；另外 M 也可以将 P 的使用权交给另一个 M (调度一个锁定状态的 G)</td>
</tr>
<tr>
<td><code>_Psyscall</code></td>
<td>当 G 被执行进入系统调用，P 会被关联的 M 设置为该状态</td>
</tr>
<tr>
<td><code>_Pgcstop</code></td>
<td>当程序运行过程中发生 GC 时，P 会被关联的 M 设为该状态</td>
</tr>
<tr>
<td><code>_Pdead</code></td>
<td>运行时如果将<code>GOMAXPROCS</code>调小，会将多余的 P 设置为该状态</td>
</tr>
</tbody>
</table>
<p>【状态转移图】</p>
<p>
        <img class="mx-auto" alt="go_scheduler-p_status" src="https://wechat-1315555539.cos.ap-nanjing.myqcloud.com/uPic/go_scheduler-p_status.png" />   
    </p>
<p>在<a href="https://www.subond.com/post/2023-08-07_gmp_m/">M如何找工作</a>中，我们已经详细分析了<code>acquireq</code>函数和<code>releasep</code>函数，今天我们看下最主要的<code>procresize</code>函数，即 P 是如何被创建的。其他函数我们会在后续的篇章中逐一讲到。</p>
<h2 id="p-的初始化">P 的初始化</h2>
<p>P 是在程序最开始的时候由调度器进行初始化，通过函数<code>procresize</code>实现，该函数在<code>schedinit</code>中被调用。</p>
<p>其源码如下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// src/runtime/proc.go#L740 这段代码在 schedinit() 函数内部
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#900;font-weight:bold">lock</span>(<span style="color:#000;font-weight:bold">&amp;</span>sched.lock)
</span></span><span style="display:flex;"><span>	sched.lastpoll.<span style="color:#900;font-weight:bold">Store</span>(<span style="color:#900;font-weight:bold">nanotime</span>())
</span></span><span style="display:flex;"><span>	procs <span style="color:#000;font-weight:bold">:=</span> ncpu
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> n, ok <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">atoi32</span>(<span style="color:#900;font-weight:bold">gogetenv</span>(<span style="color:#d14">&#34;GOMAXPROCS&#34;</span>)); ok <span style="color:#000;font-weight:bold">&amp;&amp;</span> n &gt; <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>		procs = n
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> <span style="color:#900;font-weight:bold">procresize</span>(procs) <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">throw</span>(<span style="color:#d14">&#34;unknown runnable goroutine during bootstrap&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#900;font-weight:bold">unlock</span>(<span style="color:#000;font-weight:bold">&amp;</span>sched.lock)
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里先设置 procs，它决定了 P 的数量。ncpu 已经在前面被赋上了系统的核心数，所以代码里不设置环境变量 <code>GOMAXPROCS</code> 也没问题，如果设置了，则取环境变量值。</p>
<p>我们继续往下看：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// src/runtime/proc.go#L4937
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 入参：需要创建的 P 的个数
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 出参：P 的列表
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">procresize</span>(nprocs <span style="color:#458;font-weight:bold">int32</span>) <span style="color:#000;font-weight:bold">*</span>p {
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 环境检查，确保已经上锁，确保worldstop
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#900;font-weight:bold">assertLockHeld</span>(<span style="color:#000;font-weight:bold">&amp;</span>sched.lock)
</span></span><span style="display:flex;"><span>	<span style="color:#900;font-weight:bold">assertWorldStopped</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 参数检查，程序启动时 gomaxprocs为0
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	old <span style="color:#000;font-weight:bold">:=</span> gomaxprocs
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> old &lt; <span style="color:#099">0</span> <span style="color:#000;font-weight:bold">||</span> nprocs <span style="color:#000;font-weight:bold">&lt;=</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">throw</span>(<span style="color:#d14">&#34;procresize: invalid arg&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> trace.enabled {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">traceGomaxprocs</span>(nprocs)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// update statistics
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	now <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">nanotime</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> sched.procresizetime <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>		sched.totaltime <span style="color:#000;font-weight:bold">+=</span> <span style="color:#0086b3">int64</span>(old) <span style="color:#000;font-weight:bold">*</span> (now <span style="color:#000;font-weight:bold">-</span> sched.procresizetime)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	sched.procresizetime = now
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	maskWords <span style="color:#000;font-weight:bold">:=</span> (nprocs <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">31</span>) <span style="color:#000;font-weight:bold">/</span> <span style="color:#099">32</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// Grow allp if necessary.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> nprocs &gt; <span style="color:#0086b3">int32</span>(<span style="color:#0086b3">len</span>(allp)) {
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">// Synchronize with retake, which could be running
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// concurrently since it doesn&#39;t run on a P.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#900;font-weight:bold">lock</span>(<span style="color:#000;font-weight:bold">&amp;</span>allpLock)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> nprocs <span style="color:#000;font-weight:bold">&lt;=</span> <span style="color:#0086b3">int32</span>(<span style="color:#0086b3">cap</span>(allp)) {
</span></span><span style="display:flex;"><span>      <span style="color:#998;font-style:italic">// 如果需要的 P 个数小于 allp 的容量，缩小 allp 容量
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			allp = allp[:nprocs]
</span></span><span style="display:flex;"><span>		} <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#998;font-style:italic">// 否则，创建临时 nallp 数组，并 allp 全部拷贝至 nallp
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			nallp <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">make</span>([]<span style="color:#000;font-weight:bold">*</span>p, nprocs)
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">// Copy everything up to allp&#39;s cap so we
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#998;font-style:italic">// never lose old allocated Ps.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#0086b3">copy</span>(nallp, allp[:<span style="color:#0086b3">cap</span>(allp)])
</span></span><span style="display:flex;"><span>      <span style="color:#998;font-style:italic">// 更新 allp
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			allp = nallp
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">// 以上将 allp 调整到需要的大小，即 nproc
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">// .....
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// initialize new P&#39;s
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 初始化 P, 初次启动时,old为0
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">for</span> i <span style="color:#000;font-weight:bold">:=</span> old; i &lt; nprocs; i<span style="color:#000;font-weight:bold">++</span> {
</span></span><span style="display:flex;"><span>		pp <span style="color:#000;font-weight:bold">:=</span> allp[i]
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// 申请新 P 对象
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#000;font-weight:bold">if</span> pp <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			pp = <span style="color:#0086b3">new</span>(p)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// 初始化 P，每个 P 都有一个ID，该ID就是 P 在 allp 的索引
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		pp.<span style="color:#900;font-weight:bold">init</span>(i)
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// 将 P 放入 allp 中
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#900;font-weight:bold">atomicstorep</span>(unsafe.<span style="color:#900;font-weight:bold">Pointer</span>(<span style="color:#000;font-weight:bold">&amp;</span>allp[i]), unsafe.<span style="color:#900;font-weight:bold">Pointer</span>(pp))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 以上，初始化了所有 p 对象，存放在 allp 数组中
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 获取当前正在运行的 g,初始化时后，这里就是g0
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 初始化时，g0所在的 p 还是0，所以会进入 else 逻辑
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	gp <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">getg</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> gp.m.p <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> gp.m.p.<span style="color:#900;font-weight:bold">ptr</span>().id &lt; nprocs {
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">// continue to use the current P
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// 继续使用当前的 P
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		gp.m.p.<span style="color:#900;font-weight:bold">ptr</span>().status = _Prunning
</span></span><span style="display:flex;"><span>		gp.m.p.<span style="color:#900;font-weight:bold">ptr</span>().mcache.<span style="color:#900;font-weight:bold">prepareForSweep</span>()
</span></span><span style="display:flex;"><span>	} <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// 初始化会进到这个分支，
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// ......
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// 将 g0 所在 p 清空
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		gp.m.p = <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// 取第 0 号 p，清空m, 并设置p状态为 _Pidle
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		pp <span style="color:#000;font-weight:bold">:=</span> allp[<span style="color:#099">0</span>]
</span></span><span style="display:flex;"><span>		pp.m = <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>		pp.status = _Pidle
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// acquirep() 函数将 m0/p0 关联起来
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#900;font-weight:bold">acquirep</span>(pp)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// g.m.p is now set, so we no longer need mcache0 for bootstrapping.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 此时 m0,g0 已经设置，不在需要mcache0
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	mcache0 = <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// release resources from unused P&#39;s
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 释放不在使用的 P 的资源，但不会收回 P，因为有可能处于系统调用的M还会关联 P
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">for</span> i <span style="color:#000;font-weight:bold">:=</span> nprocs; i &lt; old; i<span style="color:#000;font-weight:bold">++</span> {
</span></span><span style="display:flex;"><span>		pp <span style="color:#000;font-weight:bold">:=</span> allp[i]
</span></span><span style="display:flex;"><span>		pp.<span style="color:#900;font-weight:bold">destroy</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">// can&#39;t free P itself because it can be referenced by an M in syscall
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// Trim allp.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 如果 allp 超过了 nprocs 进行缩容，一般运行时不调整 nprocs 所以不进入这个逻辑
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> <span style="color:#0086b3">int32</span>(<span style="color:#0086b3">len</span>(allp)) <span style="color:#000;font-weight:bold">!=</span> nprocs {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">lock</span>(<span style="color:#000;font-weight:bold">&amp;</span>allpLock)
</span></span><span style="display:flex;"><span>		allp = allp[:nprocs]
</span></span><span style="display:flex;"><span>		idlepMask = idlepMask[:maskWords]
</span></span><span style="display:flex;"><span>		timerpMask = timerpMask[:maskWords]
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">unlock</span>(<span style="color:#000;font-weight:bold">&amp;</span>allpLock)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// 下面这个 for 循环检查 allp，将 空闲的P 放入全局空闲P列表；
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 如果 P 的 LRQ 不为空，即有工作可做，将这些可运行的 P 链起来
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">var</span> runnablePs <span style="color:#000;font-weight:bold">*</span>p
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">for</span> i <span style="color:#000;font-weight:bold">:=</span> nprocs <span style="color:#000;font-weight:bold">-</span> <span style="color:#099">1</span>; i <span style="color:#000;font-weight:bold">&gt;=</span> <span style="color:#099">0</span>; i<span style="color:#000;font-weight:bold">--</span> {
</span></span><span style="display:flex;"><span>		pp <span style="color:#000;font-weight:bold">:=</span> allp[i]
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// allp[0] 已经跟 m0 关联了，所以要跳过
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#000;font-weight:bold">if</span> gp.m.p.<span style="color:#900;font-weight:bold">ptr</span>() <span style="color:#000;font-weight:bold">==</span> pp {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// 将状态转为 _Pidle
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		pp.status = _Pidle
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// 如果 P 的 LRQ 为空，将其加入 全局空闲P列表
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#000;font-weight:bold">if</span> <span style="color:#900;font-weight:bold">runqempty</span>(pp) {
</span></span><span style="display:flex;"><span>			<span style="color:#900;font-weight:bold">pidleput</span>(pp, now)
</span></span><span style="display:flex;"><span>		} <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>			pp.m.<span style="color:#900;font-weight:bold">set</span>(<span style="color:#900;font-weight:bold">mget</span>())
</span></span><span style="display:flex;"><span>			pp.link.<span style="color:#900;font-weight:bold">set</span>(runnablePs)
</span></span><span style="display:flex;"><span>			runnablePs = pp
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	stealOrder.<span style="color:#900;font-weight:bold">reset</span>(<span style="color:#0086b3">uint32</span>(nprocs))
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">var</span> int32p <span style="color:#000;font-weight:bold">*</span><span style="color:#458;font-weight:bold">int32</span> = <span style="color:#000;font-weight:bold">&amp;</span>gomaxprocs <span style="color:#998;font-style:italic">// make compiler check that gomaxprocs is an int32
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	atomic.<span style="color:#900;font-weight:bold">Store</span>((<span style="color:#000;font-weight:bold">*</span><span style="color:#458;font-weight:bold">uint32</span>)(unsafe.<span style="color:#900;font-weight:bold">Pointer</span>(int32p)), <span style="color:#0086b3">uint32</span>(nprocs))
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> old <span style="color:#000;font-weight:bold">!=</span> nprocs {
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">// Notify the limiter that the amount of procs has changed.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		gcCPULimiter.<span style="color:#900;font-weight:bold">resetCapacity</span>(now, nprocs)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 返回所有可运行的 P 列表
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">return</span> runnablePs
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>总结一下，<code>procresize</code>函数主要做了以下工作：</p>
<ol>
<li>根据传入的 nproc 参数，创建这么多 P，要么复用原来的P，要么新建</li>
<li>初次启动时，该函数完成了 M0 与 P0 的关联</li>
<li>检查 allp 列表，将所有空闲的 P 放入全局空闲 P 列表，返回所有可运行的 P 列表</li>
</ol>
<p>这里面有一个关键函数<code>acquirep</code>，即关联 P 和 M，需要详细看一下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// src/runtime/proc.go#L5088
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// Associate p and the current m.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 关联 P 到当前的 M
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">acquirep</span>(pp <span style="color:#000;font-weight:bold">*</span>p) {
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// wirep 执行真正的关联
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#900;font-weight:bold">wirep</span>(pp)
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 整理mcache
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	pp.mcache.<span style="color:#900;font-weight:bold">prepareForSweep</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// ......
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到，执行关联的是<code>wirep</code>函数，继续往下看：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// src/runtime/proc.go
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">wirep</span>(pp <span style="color:#000;font-weight:bold">*</span>p) {
</span></span><span style="display:flex;"><span>	gp <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">getg</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> gp.m.p <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">throw</span>(<span style="color:#d14">&#34;wirep: already in go&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> pp.m <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span> <span style="color:#000;font-weight:bold">||</span> pp.status <span style="color:#000;font-weight:bold">!=</span> _Pidle {
</span></span><span style="display:flex;"><span>		id <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">int64</span>(<span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> pp.m <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>			id = pp.m.<span style="color:#900;font-weight:bold">ptr</span>().id
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#0086b3">print</span>(<span style="color:#d14">&#34;wirep: p-&gt;m=&#34;</span>, pp.m, <span style="color:#d14">&#34;(&#34;</span>, id, <span style="color:#d14">&#34;) p-&gt;status=&#34;</span>, pp.status, <span style="color:#d14">&#34;\n&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">throw</span>(<span style="color:#d14">&#34;wirep: invalid p state&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">// 将 P / M 相互引用，并设置 P 为 _Prunning
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	gp.m.p.<span style="color:#900;font-weight:bold">set</span>(pp)
</span></span><span style="display:flex;"><span>	pp.m.<span style="color:#900;font-weight:bold">set</span>(gp.m)
</span></span><span style="display:flex;"><span>	pp.status = _Prunning
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>到此，<code>procresize</code>函数就分析结束了。从调度器的初始化来说，工作已经完成了。</p>
<p>这里引用下阿波张公众号的文章对该函数的总结，很简洁清楚。</p>
<blockquote>
<ol>
<li>使用 make([]*p, nprocs) 初始化全局变量 allp，即 allp = make([]*p, nprocs)</li>
</ol>
</blockquote>
<blockquote>
<ol start="2">
<li>循环创建并初始化 nprocs 个 p 结构体对象并依次保存在 allp 切片之中</li>
</ol>
</blockquote>
<blockquote>
<ol start="3">
<li>把 m0 和 allp[0] 绑定在一起，即 m0.p = allp[0]，allp[0].m = m0</li>
</ol>
</blockquote>
<blockquote>
<ol start="4">
<li>把除了 allp[0] 之外的所有 p 放入到全局变量 sched 的 pidle 空闲队列之中</li>
</ol>
</blockquote>
<p>关于第四点特别说明下，从代码看，对于非空闲的 P，该函数将其生成一个链表，并返回给调用者。</p>
<p>但实际上，<code>schedinit</code>函数对<code>procresize</code>的调用并没有关心其结果，如下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// src/runtime/proc.go	
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> <span style="color:#900;font-weight:bold">procresize</span>(procs) <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">throw</span>(<span style="color:#d14">&#34;unknown runnable goroutine during bootstrap&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></td></tr></table>
</div>
</div><p>所以，初始化的时候，procresize 就是将除 allp[0] 之外的所有 P 都放入了全局空闲 P 列表。</p>
<h2 id="其他说明">其他说明</h2>
<p>通过上面对 <code>go 1.20.3</code> 版本源码的分析，做进一步的说明。</p>
<ol>
<li>参考资料 2 中，作者所使用的源码是<code>go 1.9.2</code>，新建的 P 的初始状态为<code>_Pgcstop</code>状态，但是在<code>go 1.20.3</code>版本中，新建的 P 初始状态为<code>_Pidle</code>。</li>
</ol>
<h2 id="参考资料">参考资料</h2>
<ol>
<li><a href="https://blog.tianfeiyu.com/2021/12/12/golang_gpm/">https://blog.tianfeiyu.com/2021/12/12/golang_gpm/</a></li>
<li><a href="https://golang.design/go-questions/sched/init/">https://golang.design/go-questions/sched/init/</a></li>
</ol>

        </div>

        
<div class="post-archive">
    <ul class="post-copyright">
        <li><strong>原文作者：</strong><a rel="author" href="http://www.subond.com/">Kevin</a></li>
        <li style="word-break:break-all"><strong>原文链接：</strong><a href="http://www.subond.com/post/2023-08-12_gmp_p/">http://www.subond.com/post/2023-08-12_gmp_p/</a></li>
        <li><strong>版权声明：</strong>本作品采用<a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li>
    </ul>
</div>
<br/>



        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/post/2023-08-07_gmp_m/">深入理解Go调度器：M 如何找工作（三）</a></li>
        
        <li><a href="/post/2023-07-25_gmp_g/">深入理解Go调度器：G 的创建（二）</a></li>
        
        <li><a href="/post/2023-07-24_gpm_gpm0/">深入理解Go调度器：初识GMP模型（一）</a></li>
        
        <li><a href="/post/2023-08-03_selfindulgent/">[译文]时间和财富是如何流失的</a></li>
        
        <li><a href="/post/2023-07-31_kids/">[译文]养育孩子</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/go%E8%B0%83%E5%BA%A6%E5%99%A8' target="_blank">GO调度器</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    
    

</div>

                    <footer id="footer">
    <div>
        &copy; 2023 <a href="http://www.subond.com/">凯文的个人博客 By Kevin</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://www.flysnow.org/" target="_black"><span class="badge-subject">Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>
<style type="text/css">
div.highlight {
    position: relative;
    margin: 1em 0px;
}

.copy-code {
    display: none;
    position: absolute;
    top: 4px;
    right: 4px;
    color: rgba(255, 255, 255, 0.8);
    background: rgba(78, 78, 78, 0.8);
    border-radius: var(--radius);
    padding: 0 5px;
    font: inherit;
    user-select: none;
    cursor: pointer;
    border: 0;
    --radius: 8px;
}

div.highlight:hover .copy-code,pre:hover .copy-code {
    display: block;
}

</style>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>


    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='http://www.subond.com/search' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="http://www.subond.com/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="http://www.subond.com/post/2023-08-23_gmp_scheduler_init/" title="深入理解Go调度器：调度器的初始化（五）" target="_blank">深入理解Go调度器：调度器的初始化（五）</a>
    </li>
    
    <li>
        <a href="http://www.subond.com/post/2023-08-15_go_stack/" title="[转载]Go 语言机制之栈与指针" target="_blank">[转载]Go 语言机制之栈与指针</a>
    </li>
    
    <li>
        <a href="http://www.subond.com/post/2023-08-12_gmp_p/" title="深入理解Go调度器：如何初始化P（四）" target="_blank">深入理解Go调度器：如何初始化P（四）</a>
    </li>
    
    <li>
        <a href="http://www.subond.com/post/2023-08-07_gmp_m/" title="深入理解Go调度器：M 如何找工作（三）" target="_blank">深入理解Go调度器：M 如何找工作（三）</a>
    </li>
    
    <li>
        <a href="http://www.subond.com/post/2023-08-03_selfindulgent/" title="[译文]时间和财富是如何流失的" target="_blank">[译文]时间和财富是如何流失的</a>
    </li>
    
    <li>
        <a href="http://www.subond.com/post/2023-07-31_kids/" title="[译文]养育孩子" target="_blank">[译文]养育孩子</a>
    </li>
    
    <li>
        <a href="http://www.subond.com/post/2023-07-28_wisdom/" title="[译文]智慧，是否值得？" target="_blank">[译文]智慧，是否值得？</a>
    </li>
    
    <li>
        <a href="http://www.subond.com/post/2023-07-25_gmp_g/" title="深入理解Go调度器：G 的创建（二）" target="_blank">深入理解Go调度器：G 的创建（二）</a>
    </li>
    
    <li>
        <a href="http://www.subond.com/post/2023-07-24_gpm_gpm0/" title="深入理解Go调度器：初识GMP模型（一）" target="_blank">深入理解Go调度器：初识GMP模型（一）</a>
    </li>
    
    <li>
        <a href="http://www.subond.com/post/2023-07-13_14letter/" title="No.14 来，设计你的富裕人生" target="_blank">No.14 来，设计你的富裕人生</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="http://www.subond.com/categories/go%E7%AC%94%E8%AE%B0/">Go笔记 (7)</a></li>
    
    <li><a href="http://www.subond.com/categories/go%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/">Go高性能编程 (7)</a></li>
    
    <li><a href="http://www.subond.com/categories/%E6%8A%80%E6%9C%AF/">技术 (29)</a></li>
    
    <li><a href="http://www.subond.com/categories/%E6%95%A3%E6%96%87/">散文 (10)</a></li>
    
    <li><a href="http://www.subond.com/categories/%E8%AF%91%E6%96%87%E9%9B%86/">译文集 (3)</a></li>
    
    <li><a href="http://www.subond.com/categories/%E9%B8%BF%E9%9B%81%E4%BC%A0%E4%B9%A6/">鸿雁传书 (14)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="http://www.subond.com/tags/algorithm/">algorithm</a>
    
    <a href="http://www.subond.com/tags/alignment/">alignment</a>
    
    <a href="http://www.subond.com/tags/carrer/">carrer</a>
    
    <a href="http://www.subond.com/tags/cloud/">cloud</a>
    
    <a href="http://www.subond.com/tags/defer/">defer</a>
    
    <a href="http://www.subond.com/tags/distributed-systems/">distributed systems</a>
    
    <a href="http://www.subond.com/tags/docker/">docker</a>
    
    <a href="http://www.subond.com/tags/essay/">essay</a>
    
    <a href="http://www.subond.com/tags/git/">git</a>
    
    <a href="http://www.subond.com/tags/gitbook/">gitbook</a>
    
    <a href="http://www.subond.com/tags/go/">go</a>
    
    <a href="http://www.subond.com/tags/golang/">golang</a>
    
    <a href="http://www.subond.com/tags/go%E8%B0%83%E5%BA%A6%E5%99%A8/">GO调度器</a>
    
    <a href="http://www.subond.com/tags/growth/">growth</a>
    
    <a href="http://www.subond.com/tags/life/">life</a>
    
    <a href="http://www.subond.com/tags/linux/">linux</a>
    
    <a href="http://www.subond.com/tags/mutex/">mutex</a>
    
    <a href="http://www.subond.com/tags/process/">process</a>
    
    <a href="http://www.subond.com/tags/pthread/">pthread</a>
    
    <a href="http://www.subond.com/tags/reading/">reading</a>
    
    <a href="http://www.subond.com/tags/slice/">slice</a>
    
    <a href="http://www.subond.com/tags/string/">string</a>
    
    <a href="http://www.subond.com/tags/struct/">struct</a>
    
    <a href="http://www.subond.com/tags/vagrant/">vagrant</a>
    
    <a href="http://www.subond.com/tags/work/">work</a>
    
    <a href="http://www.subond.com/tags/writing/">writing</a>
    
    <a href="http://www.subond.com/tags/%E4%BA%BA%E7%94%9F%E4%BF%A1%E5%BF%B5/">人生信念</a>
    
    <a href="http://www.subond.com/tags/%E5%86%85%E5%9C%A8%E8%AE%B0%E5%88%86%E7%89%8C/">内在记分牌</a>
    
    <a href="http://www.subond.com/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/">内存管理</a>
    
    <a href="http://www.subond.com/tags/%E5%86%99%E4%BD%9C/">写作</a>
    
    <a href="http://www.subond.com/tags/%E5%AD%A6%E4%B9%A0/">学习</a>
    
    <a href="http://www.subond.com/tags/%E5%BF%83%E7%90%86%E5%AD%A6/">心理学</a>
    
    <a href="http://www.subond.com/tags/%E6%80%9D%E8%80%83/">思考</a>
    
    <a href="http://www.subond.com/tags/%E6%83%85%E6%84%9F/">情感</a>
    
    <a href="http://www.subond.com/tags/%E6%95%99%E8%82%B2/">教育</a>
    
    <a href="http://www.subond.com/tags/%E6%97%B6%E9%97%B4/">时间</a>
    
    <a href="http://www.subond.com/tags/%E6%99%BA%E6%85%A7/">智慧</a>
    
    <a href="http://www.subond.com/tags/%E6%A0%BC%E9%9B%B7%E5%8E%84%E5%A7%86/">格雷厄姆</a>
    
    <a href="http://www.subond.com/tags/%E7%90%86%E8%B4%A2/">理财</a>
    
    <a href="http://www.subond.com/tags/%E7%94%9F%E6%B4%BB/">生活</a>
    
    <a href="http://www.subond.com/tags/%E7%BB%8F%E6%B5%8E/">经济</a>
    
    <a href="http://www.subond.com/tags/%E7%BD%91%E7%BB%9C%E5%8D%B8%E8%BD%BD/">网络卸载</a>
    
    <a href="http://www.subond.com/tags/%E8%B4%A2%E5%AF%8C/">财富</a>
    
    <a href="http://www.subond.com/tags/%E9%87%91%E9%92%B1%E5%BF%83%E7%90%86%E5%AD%A6/">金钱心理学</a>
    
    <a href="http://www.subond.com/tags/%E9%98%85%E8%AF%BB/">阅读</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="http://github.com/yusubond" title="github">Github</a>
        </li>
        
        <li>
            <a target="_blank" href="https://weibo.cn/u/2746421033" title="微博">微博</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="http://www.subond.com/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>